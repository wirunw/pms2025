<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMS - Pharmacy Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        h1, h2, h3, .font-kanit { font-family: 'Kanit', sans-serif; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-link.active { background-color: #ecfdf5; color: #059669; font-weight: bold; }
        .search-results { max-height: 200px; overflow-y: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .search-clear-btn { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); cursor: pointer; color: #9ca3af; }
        .dashboard-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); padding: 1.5rem; }
        .filter-btn.active { background-color: #059669; color: white; }
        
        /* Enhanced form styling */
        input[type="text"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.35);
            outline: none;
        }
        
        /* Enhanced button styling */
        button {
            transition: all 0.2s ease;
        }
        
        .btn-emerald {
            background-color: #059669;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .btn-emerald:hover {
            background-color: #047857;
        }

        .btn-emerald:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(236, 253, 245, 1), 0 0 0 4px rgba(16, 185, 129, 0.45);
        }
        
        .btn-blue {
            background-color: #2563eb;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .btn-blue:hover {
            background-color: #1d4ed8;
        }

        .btn-blue:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(239, 246, 255, 1), 0 0 0 4px rgba(59, 130, 246, 0.45);
        }
        
        .btn-amber {
            background-color: #d97706;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .btn-amber:hover {
            background-color: #b45309;
        }

        .btn-amber:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 247, 237, 1), 0 0 0 4px rgba(245, 158, 11, 0.45);
        }
        
        .btn-purple {
            background-color: #7c3aed;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .btn-purple:hover {
            background-color: #6d28d9;
        }

        .btn-purple:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(250, 245, 255, 1), 0 0 0 4px rgba(168, 85, 247, 0.45);
        }
        
        .btn-red {
            background-color: #dc2626;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .btn-red:hover {
            background-color: #b91c1c;
        }

        .btn-red:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(254, 242, 242, 1), 0 0 0 4px rgba(248, 113, 113, 0.45);
        }
        
        .btn-slate {
            background-color: #e2e8f0;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .btn-slate:hover {
            background-color: #cbd5f5;
        }

        .btn-slate:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(248, 250, 252, 1), 0 0 0 4px rgba(100, 116, 139, 0.45);
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 text-center font-kanit">เข้าสู่ระบบ</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginUsername" class="block text-sm font-medium text-slate-700">ชื่อผู้ใช้</label>
                    <input type="text" id="loginUsername" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" required>
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-slate-700">รหัสผ่าน</label>
                    <input type="password" id="loginPassword" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" required>
                </div>
                <button type="submit" class="w-full btn-emerald">เข้าสู่ระบบ</button>
                <div id="loginError" class="text-red-500 text-sm mt-2 hidden"></div>
            </form>
        </div>
    </div>

    <!-- Global Loader -->
    <div id="global-loader" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="loader"></div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3">
            <p id="custom-alert-message" class="text-slate-700 mb-4"></p>
            <button id="custom-alert-close" class="w-full bg-emerald-600 text-white py-2 rounded-lg hover:bg-emerald-700">ตกลง</button>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3">
            <h3 id="custom-confirm-title" class="font-bold text-lg mb-2 text-slate-800">ยืนยันการกระทำ</h3>
            <p id="custom-confirm-message" class="text-slate-700 mb-4"></p>
            <div class="flex justify-end gap-4">
                <button id="custom-confirm-cancel" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">ยกเลิก</button>
                <button id="custom-confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/2">
            <h3 class="font-bold text-lg mb-4">ถ่ายรูปยา</h3>
            <div class="relative">
                <video id="camera-video" class="w-full h-auto bg-slate-200 rounded" autoplay playsinline></video>
                <canvas id="camera-canvas" class="hidden"></canvas>
            </div>
            <img id="photo-preview" class="hidden w-full h-auto mt-2 rounded" alt="Captured photo">
            <div class="flex justify-center gap-4 mt-4">
                <button id="capture-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"><i class="fa-solid fa-camera mr-2"></i>ถ่ายภาพ</button>
                <button id="save-photo-btn" class="hidden px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700"><i class="fa-solid fa-save mr-2"></i>บันทึกรูป</button>
                <button id="retake-photo-btn" class="hidden px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">ถ่ายใหม่</button>
                <button id="close-camera-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="barcode-scanner-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/2">
            <h3 class="font-bold text-lg mb-4">สแกนบาร์โค้ด</h3>
            <video id="barcode-video" class="w-full h-auto bg-slate-200 rounded"></video>
            <p id="barcode-result" class="text-center mt-2 font-mono"></p>
            <div class="flex justify-center mt-4">
                <button id="close-barcode-scanner-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for image uploads -->
    <input type="file" id="image-upload-input" class="hidden" accept="image/*">

    <!-- Header and Navigation -->
    <header class="bg-gradient-to-r from-emerald-600 to-teal-600 shadow-lg sticky top-0 z-20">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-1 rounded-lg">
                    <img src="https://i.postimg.cc/yY1rPJ07/wirun-facbook.png" alt="Logo" class="w-10 h-10 object-contain">
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white font-kanit">PMS</h1>
                    <p class="text-xs text-emerald-100">Pharmacy Management System</p>
                </div>
            </div>
            <div class="hidden md:flex items-center space-x-1">
                <a href="#dashboard" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fa-solid fa-chart-simple mr-2 text-sm"></i> ภาพรวม
                </a>
                <a href="#pos" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fa-solid fa-cash-register mr-2 text-sm"></i> POS
                </a>
                <a href="#inventory" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fa-solid fa-boxes-stacked mr-2 text-sm"></i> คลัง
                </a>
                <a href="#members" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fa-solid fa-users mr-2 text-sm"></i> สมาชิก
                </a>
                <a href="#formulary" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fa-solid fa-prescription-bottle mr-2 text-sm"></i> ยา
                </a>
                <a href="#reports" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fa-solid fa-file-chart-column mr-2 text-sm"></i> รายงาน
                </a>
                <a href="#staffs" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fa-solid fa-user-tie mr-2 text-sm"></i> เจ้าหน้าที่
                </a>
                <a href="#users" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center hidden admin-menu">
                    <i class="fa-solid fa-users-gear mr-2 text-sm"></i> ผู้ใช้
                </a>
                <a href="#admin" class="nav-link px-4 py-2 text-emerald-100 hover:text-white hover:bg-emerald-700 rounded-lg transition-all duration-200 flex items-center hidden admin-menu">
                    <i class="fa-solid fa-shield-halved mr-2 text-sm"></i> ผู้ดูแล
                </a>
            </div>
            <button id="mobileMenuBtn" class="md:hidden text-white">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-emerald-700">
            <a href="#dashboard" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center">
                <i class="fa-solid fa-chart-simple mr-3"></i> ภาพรวม
            </a>
            <a href="#pos" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center">
                <i class="fa-solid fa-cash-register mr-3"></i> POS
            </a>
            <a href="#inventory" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center">
                <i class="fa-solid fa-boxes-stacked mr-3"></i> คลัง
            </a>
            <a href="#members" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center">
                <i class="fa-solid fa-users mr-3"></i> สมาชิก
            </a>
            <a href="#formulary" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center">
                <i class="fa-solid fa-prescription-bottle mr-3"></i> ยา
            </a>
            <a href="#reports" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center">
                <i class="fa-solid fa-file-chart-column mr-3"></i> รายงาน
            </a>
            <a href="#staffs" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center">
                <i class="fa-solid fa-user-tie mr-3"></i> เจ้าหน้าที่
            </a>
            <a href="#users" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center hidden admin-menu">
                <i class="fa-solid fa-users-gear mr-3"></i> ผู้ใช้
            </a>
            <a href="#admin" class="block nav-link px-4 py-3 text-emerald-100 hover:text-white hover:bg-emerald-800 flex items-center hidden admin-menu">
                <i class="fa-solid fa-shield-halved mr-3"></i> ผู้ดูแล
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6">

        <!-- Page: Dashboard -->
        <div id="page-dashboard" class="page">
             <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold text-slate-800 font-kanit">ภาพรวมระบบ</h2>
                 <div class="flex flex-wrap items-center gap-2">
                    <button class="filter-btn px-4 py-2 text-sm rounded-lg bg-white shadow-sm" data-period="daily">วันนี้</button>
                    <button class="filter-btn px-4 py-2 text-sm rounded-lg bg-white shadow-sm" data-period="weekly">สัปดาห์นี้</button>
                    <button class="filter-btn px-4 py-2 text-sm rounded-lg bg-white shadow-sm" data-period="monthly">เดือนนี้</button>
                    <button class="filter-btn px-4 py-2 text-sm rounded-lg bg-white shadow-sm" data-period="yearly">ปีนี้</button>
                 </div>
             </div>

             <!-- Key Metrics Cards -->
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
                <!-- Total Sales -->
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-xl p-5 shadow-sm">
                    <div class="flex items-center">
                        <div class="p-3 bg-emerald-100 rounded-lg">
                            <i class="fa-solid fa-cash-register text-emerald-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-emerald-700">ยอดขายรวม</p>
                            <h3 id="dashboard-total-sales" class="text-2xl font-bold text-slate-800">0.00 บาท</h3>
                        </div>
                    </div>
                </div>

                <!-- Total Transactions -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-5 shadow-sm">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i class="fa-solid fa-receipt text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-blue-700">จำนวนรายการขาย</p>
                            <h3 id="dashboard-total-transactions" class="text-2xl font-bold text-slate-800">0</h3>
                        </div>
                    </div>
                </div>

                <!-- Total Members -->
                <div class="bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-xl p-5 shadow-sm">
                    <div class="flex items-center">
                        <div class="p-3 bg-amber-100 rounded-lg">
                            <i class="fa-solid fa-users text-amber-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-amber-700">จำนวนสมาชิก</p>
                            <h3 id="dashboard-total-members" class="text-2xl font-bold text-slate-800">0</h3>
                        </div>
                    </div>
                </div>

                <!-- Products Low Stock -->
                <div class="bg-gradient-to-br from-red-50 to-red-100 border border-red-200 rounded-xl p-5 shadow-sm">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-red-700">ต่ำกว่า Min Stock</p>
                            <h3 id="dashboard-low-stock-count" class="text-2xl font-bold text-slate-800">0</h3>
                        </div>
                    </div>
                </div>
             </div>

             <!-- Charts Section -->
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Sales Trend Chart -->
                <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                    <h3 class="font-bold text-slate-700 font-kanit mb-4 flex items-center">
                        <i class="fa-solid fa-chart-line mr-2 text-emerald-600"></i> แนวโน้มยอดขาย
                    </h3>
                    <div class="h-64 flex items-center justify-center" id="sales-chart-container">
                        <p class="text-slate-500">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>

                <!-- Top Selling Drugs -->
                <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                    <h3 class="font-bold text-slate-700 font-kanit mb-4 flex items-center">
                        <i class="fa-solid fa-pills mr-2 text-blue-600"></i> 10 ยาขายดี
                    </h3>
                    <div class="h-64" id="top-drugs-chart-container">
                        <p class="text-slate-500 text-center py-10">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>
             </div>

             <!-- Tables Section -->
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Top Members -->
                <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                    <h3 class="font-bold text-slate-700 font-kanit mb-4 flex items-center">
                        <i class="fa-solid fa-crown mr-2 text-amber-600"></i> สมาชิกซื้อมากที่สุด
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    <th class="px-4 py-3">ชื่อสมาชิก</th>
                                    <th class="px-4 py-3">จำนวนเงิน</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-top-members-table">
                                <tr><td colspan="2" class="text-center py-4 text-slate-500">กำลังโหลดข้อมูล...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Low Stock & Expiring Items -->
                <div class="space-y-6">
                    <!-- Low Stock Items -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                        <h3 class="font-bold text-slate-700 font-kanit mb-4 flex items-center">
                            <i class="fa-solid fa-exclamation-triangle mr-2 text-red-600"></i> สินค้าต่ำกว่า Min
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3">ชื่อยา</th>
                                        <th class="px-4 py-3">คงเหลือ</th>
                                        <th class="px-4 py-3">Min</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-low-stock-table">
                                    <tr><td colspan="3" class="text-center py-4 text-slate-500">กำลังโหลดข้อมูล...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Expiring Items -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                        <h3 class="font-bold text-slate-700 font-kanit mb-4 flex items-center">
                            <i class="fa-solid fa-clock mr-2 text-orange-600"></i> สินค้าใกล้หมดอายุ
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3">ชื่อยา</th>
                                        <th class="px-4 py-3">Lot</th>
                                        <th class="px-4 py-3">วันหมดอายุ</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-expiring-table">
                                    <tr><td colspan="3" class="text-center py-4 text-slate-500">กำลังโหลดข้อมูล...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- Page: Point of Sale (POS) -->
        <div id="page-pos" class="page">
             <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">ขายหน้าร้าน (POS)</h2>
            <form id="posForm" class="bg-white p-6 rounded-lg shadow-lg space-y-6" onsubmit="return false;">
                <!-- Member Section -->
                <div class="border-b pb-4">
                    <h3 class="font-bold text-lg mb-2">ข้อมูลลูกค้า</h3>
                    <div class="relative">
                        <input type="text" id="posMemberSearch" placeholder="ค้นหาชื่อ หรือ เบอร์โทรศัพท์ลูกค้า..." class="w-full p-2 border rounded">
                        <i id="posMemberClear" class="fa-solid fa-xmark search-clear-btn hidden"></i>
                        <div id="posMemberResults" class="search-results absolute w-full bg-white border rounded-b-lg shadow-lg z-10 hidden"></div>
                    </div>
                    <div id="posSelectedMember" class="mt-2 text-sm flex justify-between items-center">
        <span id="memberInfoText"></span>
        <button id="viewMemberHistoryBtn" class="hidden text-sm text-blue-600 hover:text-blue-800">ดูประวัติ</button>
    </div>
                </div>

                <!-- Drug Selection Section -->
                 <div class="border-b pb-4">
                    <h3 class="font-bold text-lg mb-2">เลือกรายการยา (FEFO)</h3>
                     <div class="flex items-end gap-2 mb-2">
                        <div class="relative flex-grow">
                            <label class="text-sm">ค้นหายา (จากคลังที่มีขาย)</label>
                            <input type="text" id="posDrugSearch" placeholder="พิมพ์ชื่อการค้า หรือ ชื่อสามัญ..." class="w-full p-2 border rounded">
                            <i id="posDrugClear" class="fa-solid fa-xmark search-clear-btn hidden" style="right: 0.5rem; top: 2.125rem;"></i>
                            <div id="posDrugResults" class="search-results absolute w-full bg-white border rounded-b-lg shadow-lg z-10 hidden"></div>
                        </div>
                        <button type="button" id="posScanBarcodeBtn" class="p-2 border rounded bg-slate-100 hover:bg-slate-200" title="สแกนบาร์โค้ด"><i class="fa-solid fa-barcode text-xl"></i></button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="md:col-span-3">
                             <label class="text-sm">เลือก Lot (ใกล้หมดอายุก่อน)</label>
                             <select id="posLotSelect" class="w-full p-2 border rounded bg-white"></select>
                        </div>
                         <div class="md:col-span-2">
                             <label class="text-sm">จำนวน</label>
                             <input type="number" id="posQuantity" value="1" min="1" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <div id="posDrugInfo" class="mt-4 text-sm bg-slate-50 p-3 rounded-lg border border-slate-200 hidden"></div>
                    <button type="button" id="posAddToCartBtn" class="w-full mt-4 bg-emerald-600 text-white py-2 rounded-lg hover:bg-emerald-700">เพิ่มลงตะกร้า</button>
                </div>
                
                <!-- Cart Section -->
                <div>
                    <h3 class="font-bold text-lg mb-2">ตะกร้าสินค้า</h3>
                     <div class="border rounded-lg min-h-[100px] p-2 bg-slate-50">
                        <table class="w-full text-sm"><thead class="border-b-2"><tr><th class="text-left p-1">รายการ</th><th class="p-1">Lot</th><th class="p-1">จำนวน</th><th class="text-right p-1">รวม</th><th></th></tr></thead><tbody id="posCartItems"></tbody></table>
                    </div>
                    <button type="button" id="posResetCartBtn" class="text-sm text-red-600 mt-2 hover:underline">ล้างตะกร้า</button>
                </div>

                <!-- Payment Section -->
                <div class="border-t pt-4 space-y-2">
                    <div class="flex justify-between items-center text-xl font-bold">
                        <span>ยอดรวม:</span>
                        <span id="posTotalAmount">0.00 บาท</span>
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="posCashReceived">รับเงินมา:</label>
                        <input type="number" id="posCashReceived" class="w-1/2 p-2 border rounded text-right" step="0.01">
                    </div>
                     <div class="flex justify-between items-center font-bold">
                        <span>เงินทอน:</span>
                        <span id="posChangeGiven" class="text-lg">0.00</span>
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="posPharmacist">ผู้ขาย (เภสัชกร):</label>
                        <input type="text" id="posPharmacist" class="w-1/2 p-2 border rounded" required>
                    </div>
                    <button type="submit" id="posSubmitSaleBtn" class="w-full btn-blue text-lg font-bold">บันทึกการขาย</button>
                    <div id="posPostSaleActions" class="hidden w-full flex gap-4">
                        <button type="button" id="posPrintReceiptBtn" class="flex-grow btn-blue text-lg font-bold">พิมพ์ใบเสร็จ</button>
                        <button type="button" id="posNewSaleBtn" class="flex-grow btn-emerald text-lg font-bold">ขายรายการใหม่</button>
                    </div>
                    <div id="posResponseMsg" class="text-center text-sm font-semibold mt-2"></div>
                </div>
            </form>
        </div>

        <!-- Page: Inventory Management -->
        <div id="page-inventory" class="page">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">จัดการคลังสินค้า</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-4">รับสินค้าเข้า (Goods Received)</h3>
                <form id="goodsReceivedForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative md:col-span-2">
                        <label>ค้นหารายการยาจาก Formulary</label>
                        <input type="text" id="invDrugSearch" placeholder="พิมพ์ชื่อยา..." class="w-full p-2 border rounded">
                        <i id="invDrugClear" class="fa-solid fa-xmark search-clear-btn hidden" style="right: 0.5rem; top: 2.125rem;"></i>
                        <div id="invDrugResults" class="search-results absolute w-full bg-white border rounded-b-lg shadow-lg z-10 hidden"></div>
                        <input type="hidden" id="invSelectedDrugId">
                    </div>
                     <div class="md:col-span-2">
                        <label>บาร์โค้ด</label>
                        <div class="flex items-center gap-2">
                             <input type="text" id="invBarcode" placeholder="Barcode" class="flex-grow p-2 border rounded">
                             <button type="button" id="invScanBarcodeBtn" class="p-2 border rounded bg-slate-100 hover:bg-slate-200" title="สแกนบาร์โค้ด"><i class="fa-solid fa-barcode text-xl"></i></button>
                        </div>
                    </div>
                    <input type="text" id="invLotNumber" placeholder="Lot Number" class="p-2 border rounded" required>
                    <input type="date" id="invExpiryDate" placeholder="วันหมดอายุ" class="p-2 border rounded" required>
                    <input type="number" id="invQuantity" placeholder="จำนวน" class="p-2 border rounded" required min="1">
                    <input type="number" id="invCostPrice" placeholder="ราคาทุน/หน่วย" class="p-2 border rounded" required step="0.01" min="0">
                    <input type="number" id="invSellingPrice" placeholder="ราคาขาย/หน่วย" class="p-2 border rounded" required step="0.01" min="0">
                    <input type="text" id="invReferenceId" placeholder="เลขอ้างอิง (ถ้ามี)" class="p-2 border rounded">
                    <button type="submit" class="md:col-span-2 btn-emerald">บันทึกรับเข้า</button>
                </form>
            </div>
             <div class="mt-6 bg-white p-6 rounded-lg shadow">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">สรุปยอดสินค้าคงคลัง</h3>
                    <button id="refreshInventoryBtn" class="px-3 py-1 text-sm bg-slate-200 rounded-lg hover:bg-slate-300">Refresh</button>
                </div>
                <div id="inventoryTable" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- Page: Member Management (CRM) -->
        <div id="page-members" class="page">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">จัดการสมาชิก</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-4">เพิ่มสมาชิกใหม่</h3>
                <form id="addMemberForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="memberFullName" placeholder="ชื่อ-นามสกุล" class="p-2 border rounded" required>
                        <input type="text" id="memberNationalID" placeholder="เลขบัตรประชาชน" class="p-2 border rounded">
                        <input type="date" id="memberDob" placeholder="วันเดือนปีเกิด" class="p-2 border rounded">
                        <input type="tel" id="memberPhone" placeholder="เบอร์โทรศัพท์" class="p-2 border rounded">
                        <textarea id="memberDisease" placeholder="โรคประจำตัว" class="p-2 border rounded md:col-span-2" rows="2"></textarea>
                    </div>
                    
                    <div>
                        <h4 class="font-bold mt-2 mb-2">ประวัติการแพ้ยา</h4>
                        <div id="allergies-container" class="space-y-2">
                            <!-- Allergy fields will be generated here by JS -->
                        </div>
                    </div>

                    <button type="submit" class="w-full btn-emerald">บันทึกสมาชิก</button>
                </form>
            </div>
            <div class="mt-6 bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">รายชื่อสมาชิก</h3>
                    <button id="refreshMembersBtn" class="px-3 py-1 text-sm bg-slate-200 rounded-lg hover:bg-slate-300">Refresh</button>
                </div>
                <div id="membersTable" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- Page: Drug Formulary -->
        <div id="page-formulary" class="page">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">จัดการข้อมูลยา (Formulary)</h2>
             <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-4">เพิ่ม/แก้ไขรายการยา</h3>
                <form id="addDrugForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="drugId" placeholder="รหัสยา (SKU)" class="p-2 border rounded" required>
                    <input type="text" id="tradeName" placeholder="ชื่อการค้า" class="p-2 border rounded" required>
                    <input type="text" id="genericName" placeholder="ชื่อสามัญ" class="p-2 border rounded">
                    
                    <select id="legalCategory" class="p-2 border rounded bg-white" required>
                        <option value="" disabled selected>-- ประเภทสินค้าตามกฎหมาย --</option>
                        <option value="ยาอันตราย">ยาอันตราย</option>
                        <option value="ยาควบคุมพิเศษ">ยาควบคุมพิเศษ</option>
                        <option value="ยาบรรจุเสร็จ">ยาบรรจุเสร็จ (ทั่วไป)</option>
                        <option value="ยาสามัญประจำบ้าน">ยาสามัญประจำบ้าน</option>
                        <option value="ผลิตภัณฑ์เสริมอาหาร">ผลิตภัณฑ์เสริมอาหาร</option>
                        <option value="เครื่องมือแพทย์">เครื่องมือแพทย์</option>
                        <option value="เครื่องสำอาง">เครื่องสำอาง</option>
                        <option value="ผลิตภัณฑ์สมุนไพร">ผลิตภัณฑ์สมุนไพร</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>

                    <select id="pharmaCategory" class="p-2 border rounded bg-white" required>
                        <option value="" disabled selected>-- ประเภทสินค้าตามการใช้งาน --</option>
                        <optgroup label="กลุ่มยา">
                            <option value="ยาแก้ปวด ลดไข้ ต้านอักเสบ">ยาแก้ปวด ลดไข้ ต้านอักเสบ</option>
                            <option value="ยาปฏิชีวนะ">ยาปฏิชีวนะ</option>
                            <option value="ยาแก้แพ้ ลดน้ำมูก แก้ไอ">ยาแก้แพ้ ลดน้ำมูก แก้ไอ</option>
                            <option value="ยาสำหรับระบบทางเดินอาหาร">ยาสำหรับระบบทางเดินอาหาร</option>
                            <option value="ยาสำหรับโรคเรื้อรัง">ยาสำหรับโรคเรื้อรัง</option>
                            <option value="ยาใช้ภายนอก">ยาใช้ภายนอก</option>
                            <option value="วิตามินและแร่ธาตุ (ยา)">วิตามินและแร่ธาตุ (ยา)</option>
                        </optgroup>
                        <optgroup label="ผลิตภัณฑ์เสริมอาหาร">
                            <option value="เสริมภูมิคุ้มกัน">เสริมภูมิคุ้มกัน</option>
                            <option value="บำรุงผิว ผม เล็บ">บำรุงผิว ผม เล็บ</option>
                            <option value="บำรุงกระดูกและข้อ">บำรุงกระดูกและข้อ</option>
                            <option value="บำรุงสมองและความจำ">บำรุงสมองและความจำ</option>
                            <option value="ควบคุมน้ำหนัก">ควบคุมน้ำหนัก</option>
                            <option value="สุขภาพลำไส้และโปรไบโอติกส์">สุขภาพลำไส้และโปรไบโอติกส์</option>
                        </optgroup>
                        <optgroup label="เครื่องมือแพทย์">
                            <option value="อุปกรณ์ตรวจวัด">อุปกรณ์ตรวจวัด</option>
                            <option value="อุปกรณ์ทำแผลและปฐมพยาบาล">อุปกรณ์ทำแผลและปฐมพยาบาล</option>
                            <option value="อุปกรณ์พยุงร่างกาย">อุปกรณ์พยุงร่างกาย</option>
                        </optgroup>
                        <optgroup label="เครื่องสำอาง/เวชสำอาง">
                            <option value="ผลิตภัณฑ์ทำความสะอาด">ผลิตภัณฑ์ทำความสะอาด</option>
                            <option value="ผลิตภัณฑ์ให้ความชุ่มชื้น">ผลิตภัณฑ์ให้ความชุ่มชื้น</option>
                            <option value="ผลิตภัณฑ์สำหรับสิว">ผลิตภัณฑ์สำหรับสิว</option>
                            <option value="ผลิตภัณฑ์ป้องกันแสงแดด">ผลิตภัณฑ์ป้องกันแสงแดด</option>
                        </optgroup>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>

                    <input type="text" id="strength" placeholder="ขนาด/ความแรง" class="p-2 border rounded">

                    <select id="unit" class="p-2 border rounded bg-white" required>
                        <option value="" disabled selected>-- หน่วยนับ --</option>
                        <option value="เม็ด">เม็ด</option>
                        <option value="แคปซูล">แคปซูล</option>
                        <option value="ขวด">ขวด</option>
                        <option value="หลอด">หลอด</option>
                        <option value="ซอง">ซอง</option>
                        <option value="กล่อง">กล่อง</option>
                        <option value="แผง">แผง</option>
                        <option value="ชิ้น">ชิ้น</option>
                        <option value="มิลลิลิตร">มิลลิลิตร</option>
                        <option value="กรัม">กรัม</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                    
                    <h4 class="font-bold md:col-span-3 mt-2">การจัดการสต็อก</h4>
                    <input type="number" id="minStock" placeholder="จำนวนขั้นต่ำ (Min Stock)" class="p-2 border rounded">
                    <input type="number" id="maxStock" placeholder="จำนวนสูงสุด (Max Stock)" class="p-2 border rounded">
                    
                    <textarea id="indication" placeholder="ข้อบ่งใช้" class="p-2 border rounded md:col-span-3" rows="2"></textarea>
                    <textarea id="caution" placeholder="ข้อควรระวัง" class="p-2 border rounded md:col-span-3" rows="2"></textarea>
                    
                    <h4 class="font-bold md:col-span-3 mt-2">รายการยาที่ตีกัน (Drug Interaction)</h4>
                    <input type="text" id="interaction1" placeholder="ชื่อสามัญของยาที่ตีกัน 1" class="p-2 border rounded">
                    <input type="text" id="interaction2" placeholder="ชื่อสามัญของยาที่ตีกัน 2" class="p-2 border rounded">
                    <input type="text" id="interaction3" placeholder="ชื่อสามัญของยาที่ตีกัน 3" class="p-2 border rounded">
                    <input type="text" id="interaction4" placeholder="ชื่อสามัญของยาที่ตีกัน 4" class="p-2 border rounded">
                    <input type="text" id="interaction5" placeholder="ชื่อสามัญของยาที่ตีกัน 5" class="p-2 border rounded">

                    <button type="submit" class="md:col-span-3 btn-emerald">บันทึกข้อมูลยา</button>
                </form>
            </div>
             <div class="mt-6 bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">รายการยาทั้งหมด</h3>
                    <button id="refreshDrugsBtn" class="px-3 py-1 text-sm bg-slate-200 rounded-lg hover:bg-slate-300">Refresh</button>
                </div>
                <div id="formularyTable" class="overflow-x-auto"></div>
            </div>
        </div>
        
        <!-- Page: Reports -->
        <div id="page-reports" class="page">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">รายงาน</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex flex-wrap items-end gap-4 mb-4">
                    <div>
                        <label for="reportType" class="text-sm font-medium">ประเภทรายงาน:</label>
                        <select id="reportType" class="p-2 border rounded bg-white">
                            <option value="dailySales">ยอดขายรายวัน</option>
                            <option value="weeklySales">ยอดขายรายสัปดาห์</option>
                            <option value="monthlySales">ยอดขายรายเดือน</option>
                            <option value="yearlySales">ยอดขายรายปี</option>
                            <option value="inventory">รายงานสินค้าคงคลัง</option>
                            <option value="members">รายงานข้อมูลสมาชิก</option>
                        </select>
                    </div>
                    <!-- Date pickers container -->
                    <div id="date-pickers-container" class="flex flex-wrap items-end gap-4">
                        <div id="daily-picker-container">
                            <label for="reportDate" class="text-sm font-medium">วันที่:</label>
                            <input type="date" id="reportDate" class="p-2 border rounded">
                        </div>
                         <div id="weekly-picker-container" class="hidden">
                            <label for="reportWeek" class="text-sm font-medium">เลือกวันในสัปดาห์:</label>
                            <input type="date" id="reportWeek" class="p-2 border rounded">
                        </div>
                        <div id="monthly-picker-container" class="hidden">
                            <label for="reportMonth" class="text-sm font-medium">เดือน/ปี:</label>
                            <input type="month" id="reportMonth" class="p-2 border rounded">
                        </div>
                        <div id="yearly-picker-container" class="hidden">
                            <label for="reportYear" class="text-sm font-medium">ปี:</label>
                            <input type="number" id="reportYear" class="p-2 border rounded w-28" placeholder="YYYY">
                        </div>
                    </div>
                    <button id="generateReportBtn" class="btn-blue">สร้างรายงาน</button>
                </div>
                <div id="reportResultTable" class="overflow-x-auto">
                    <p class="text-center text-slate-500">กรุณาเลือกประเภทรายงานและกด "สร้างรายงาน"</p>
                </div>
                 <div id="reportSummary" class="mt-4 text-right font-bold"></div>
            </div>
        </div>
        
        <!-- Page: Staff Management -->
        <div id="page-staffs" class="page">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">จัดการเจ้าหน้าที่</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-4">เพิ่มเจ้าหน้าที่ใหม่</h3>
                <form id="addStaffForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="staffFullName" placeholder="ชื่อ-นามสกุล" class="p-2 border rounded" required>
                        <input type="text" id="staffLicenseNumber" placeholder="เลขที่ใบประกอบวิชาชีพ (ถ้ามี)" class="p-2 border rounded">
                        <input type="text" id="staffPosition" placeholder="ตำแหน่ง" class="p-2 border rounded">
                        <input type="tel" id="staffPhone" placeholder="เบอร์โทรศัพท์" class="p-2 border rounded">
                        <input type="email" id="staffEmail" placeholder="อีเมล" class="p-2 border rounded md:col-span-2">
                    </div>
                    <button type="submit" class="w-full btn-emerald">บันทึกเจ้าหน้าที่</button>
                </form>
            </div>
            <div class="mt-6 bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">รายชื่อเจ้าหน้าที่</h3>
                    <button id="refreshStaffsBtn" class="px-3 py-1 text-sm bg-slate-200 rounded-lg hover:bg-slate-300">Refresh</button>
                </div>
                <div id="staffsTable" class="overflow-x-auto"></div>
            </div>
        </div>
        
        <!-- Page: User Management -->
        <div id="page-users" class="page">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">จัดการผู้ใช้งาน</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-4">เปลี่ยนรหัสผ่าน</h3>
                <form id="changePasswordForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="password" id="currentPassword" placeholder="รหัสผ่านเดิม" class="p-2 border rounded" required>
                        <input type="password" id="newPassword" placeholder="รหัสผ่านใหม่" class="p-2 border rounded" required>
                        <input type="password" id="confirmNewPassword" placeholder="ยืนยันรหัสผ่านใหม่" class="p-2 border rounded md:col-span-2" required>
                    </div>
                    <button type="submit" class="w-full btn-emerald">เปลี่ยนรหัสผ่าน</button>
                </form>
            </div>
            
            <div id="adminUserManagement" class="hidden mt-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-lg mb-4">เพิ่มผู้ใช้งานใหม่</h3>
                    <form id="addUserForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="newUsername" placeholder="ชื่อผู้ใช้" class="p-2 border rounded" required>
                            <input type="text" id="newFullName" placeholder="ชื่อ-นามสกุล" class="p-2 border rounded" required>
                            <input type="password" id="newPasswordUser" placeholder="รหัสผ่าน" class="p-2 border rounded" required>
                            <select id="newUserRole" class="p-2 border rounded bg-white" required>
                                <option value="user" selected>ผู้ใช้งานทั่วไป</option>
                                <option value="admin">ผู้ดูแลระบบ</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full btn-emerald">เพิ่มผู้ใช้งาน</button>
                    </form>
                </div>
                
                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">รายชื่อผู้ใช้งานทั้งหมด</h3>
                        <button id="refreshUsersBtn" class="px-3 py-1 text-sm bg-slate-200 rounded-lg hover:bg-slate-300">Refresh</button>
                    </div>
                    <div id="usersTable" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
        
        <!-- Page: Admin Dashboard -->
        <div id="page-admin" class="page">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">แดชบอร์ดผู้ดูแลระบบ</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Total Users Card -->
                <div class="dashboard-card">
                    <h3 class="font-bold text-slate-600 font-kanit">จำนวนผู้ใช้งานทั้งหมด</h3>
                    <p id="admin-total-users" class="text-4xl font-bold text-emerald-600 mt-2">0</p>
                </div>
                
                <!-- Total Sales Card -->
                <div class="dashboard-card">
                    <h3 class="font-bold text-slate-600 font-kanit">ยอดขายรวม</h3>
                    <p id="admin-total-sales" class="text-4xl font-bold text-blue-600 mt-2">0.00 บาท</p>
                </div>
                
                <!-- Total Members Card -->
                <div class="dashboard-card">
                    <h3 class="font-bold text-slate-600 font-kanit">จำนวนสมาชิก</h3>
                    <p id="admin-total-members" class="text-4xl font-bold text-amber-600 mt-2">0</p>
                </div>
                
                <!-- Total Drugs Card -->
                <div class="dashboard-card">
                    <h3 class="font-bold text-slate-600 font-kanit">จำนวนยาในระบบ</h3>
                    <p id="admin-total-drugs" class="text-4xl font-bold text-purple-600 mt-2">0</p>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="font-bold text-lg mb-4">กิจกรรมล่าสุด</h3>
                <div id="admin-recent-activity" class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr>
                                <th class="px-6 py-3">เวลา</th>
                                <th class="px-6 py-3">กิจกรรม</th>
                                <th class="px-6 py-3">ผู้ใช้งาน</th>
                                <th class="px-6 py-3">รายละเอียด</th>
                            </tr>
                        </thead>
                        <tbody id="admin-activity-list">
                            <!-- Activity rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-4">ส่งออกข้อมูล</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button id="export-sales-btn" class="btn-emerald">ส่งออกยอดขาย</button>
                    <button id="export-inventory-btn" class="btn-blue">ส่งออกสต๊อกสินค้า</button>
                    <button id="export-members-btn" class="btn-amber">ส่งออกข้อมูลสมาชิก</button>
                    <button id="export-staffs-btn" class="btn-purple">ส่งออกข้อมูลเจ้าหน้าที่</button>
                </div>
            </div>
        </div>
        
        <!-- Page: Settings -->
        <div id="page-settings" class="page">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 font-kanit">ตั้งค่า</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-4">การตั้งค่าระบบ</h3>
                <div class="space-y-4">
                    <div>
                        <label for="settingsScriptUrl" class="block text-sm font-medium text-slate-700">API Server URL</label>
                        <p class="text-sm text-slate-500 mb-1">URL ของเซิร์ฟเวอร์ API สำหรับระบบจัดการร้านยา (Node.js + SQLite)</p>
                        <input type="text" id="settingsScriptUrl" placeholder="https://your-domain.railway.app" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <button id="settingsSaveBtn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">บันทึกการตั้งค่า</button>
                    <p id="settingsStatusMsg" class="text-sm text-emerald-600 mt-2"></p>
                </div>
            </div>
        </div>

        <!-- Purchase History Modal -->
        <div id="purchaseHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/2 max-h-[80vh] overflow-y-auto">
                <h3 class="font-bold text-lg mb-4">ประวัติการซื้อของลูกค้า</h3>
                <div id="purchaseHistoryContent"></div>
                <div class="mt-4 flex justify-end">
                    <button id="closePurchaseHistoryBtn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">ปิด</button>
                </div>
            </div>
        </div>

    </main>

<script>
'use strict';

// ===================================================================================
// ===== CONFIGURATION: API Server URL (Default to local server) =====================
// ===================================================================================
let API_URL = localStorage.getItem('pharmacyAppApiUrl') || (window.location.origin + "/api");
// ===================================================================================

// --- Basic Setup, Navigation, and Modals ---
const pages = document.querySelectorAll('.page');
const navLinks = document.querySelectorAll('.nav-link');
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const mobileMenu = document.getElementById('mobileMenu');
const globalLoader = document.getElementById('global-loader');
// --- Custom Modals
const customAlertModal = document.getElementById('custom-alert-modal');
const customAlertMessage = document.getElementById('custom-alert-message');
const customAlertCloseBtn = document.getElementById('custom-alert-close');
const customConfirmModal = document.getElementById('custom-confirm-modal');
const customConfirmTitle = document.getElementById('custom-confirm-title');
const customConfirmMessage = document.getElementById('custom-confirm-message');
const customConfirmOkBtn = document.getElementById('custom-confirm-ok');
const customConfirmCancelBtn = document.getElementById('custom-confirm-cancel');
// --- Camera Modal
const cameraModal = document.getElementById('camera-modal');
const video = document.getElementById('camera-video');
const canvas = document.getElementById('camera-canvas');
const photoPreview = document.getElementById('photo-preview');
const captureBtn = document.getElementById('capture-btn');
const savePhotoBtn = document.getElementById('save-photo-btn');
const retakePhotoBtn = document.getElementById('retake-photo-btn');
const closeCameraBtn = document.getElementById('close-camera-btn');
let stream;
let currentDrugIdForPhoto = null;
const imageUploadInput = document.getElementById('image-upload-input');

// --- Barcode Scanner Modal ---
const barcodeScannerModal = document.getElementById('barcode-scanner-modal');
const barcodeVideo = document.getElementById('barcode-video');
const closeBarcodeScannerBtn = document.getElementById('close-barcode-scanner-btn');
let barcodeScannerCallback = null;
const codeReader = new ZXing.BrowserMultiFormatReader();

let confirmResolve = null;

function showPage(pageId) {
    pages.forEach(page => page.classList.remove('active'));
    navLinks.forEach(link => link.classList.remove('active'));
    const activePage = document.getElementById(`page-${pageId}`);
    if (activePage) activePage.classList.add('active');
    const activeLinks = document.querySelectorAll(`.nav-link[href=\"#${pageId}\"]`);
    activeLinks.forEach(link => link.classList.add('active'));
    mobileMenu.classList.add('hidden');
    switch (pageId) {
        case 'dashboard': loadDashboard('daily'); break;
        case 'members': loadMembers(); break;
        case 'formulary': loadFormulary(); break;
        case 'inventory': loadInventorySummary(); break;
        case 'pos': loadPOSData(); break;
        case 'reports': loadReports(); break;
        case 'settings': loadSettings(); break;
    }
}

navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const pageId = e.currentTarget.hash.substring(1);
        window.location.hash = pageId;
    });
});

window.addEventListener('hashchange', () => {
    const pageId = window.location.hash.substring(1) || 'dashboard';
    showPage(pageId);
});

mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

document.addEventListener('DOMContentLoaded', () => {
    loadSettings(); // Load URL from localStorage on startup
    // ตรวจสอบว่า URL ถูกตั้งค่าหรือไม่
    if (!API_URL || API_URL === "http://localhost:3000/api") {
        // ใช้ค่าเริ่มต้น ไม่ต้องแสดง alert
    }
    const pageId = window.location.hash.substring(1) || 'dashboard';
    showPage(pageId);
    generateAllergyFields();
});

// --- Custom Modals ---
function showCustomAlert(message) {
    customAlertMessage.textContent = message;
    customAlertModal.classList.remove('hidden');
}

customAlertCloseBtn.addEventListener('click', () => customAlertModal.classList.add('hidden'));

function showConfirmation(message, title = 'ยืนยันการกระทำ') {
    return new Promise((resolve) => {
        confirmResolve = resolve;
        customConfirmTitle.textContent = title;
        customConfirmMessage.innerHTML = message; // Use innerHTML to allow for formatting
        customConfirmModal.classList.remove('hidden');
    });
}

customConfirmOkBtn.addEventListener('click', () => {
    customConfirmModal.classList.add('hidden');
    if (confirmResolve) confirmResolve(true);
});

customConfirmCancelBtn.addEventListener('click', () => {
    customConfirmModal.classList.add('hidden');
    if (confirmResolve) confirmResolve(false);
});

// --- Loader and API Helper ---
const showLoader = () => globalLoader.classList.remove('hidden');
const hideLoader = () => globalLoader.classList.add('hidden');

async function apiCall(endpoint, params = {}, includeAuth = true, options = {}) {
    if (!API_URL) {
        showCustomAlert('กรุณาตั้งค่า API Server URL ในหน้า "ตั้งค่า"');
        return Promise.reject('URL not configured');
    }
    showLoader();
    try {
        const url = new URL(`${API_URL}/${endpoint}`);
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        
        const headers = { method: 'GET' };
        // ดึง token จาก localStorage ถ้ามี และ includeAuth ถูกตั้งเป็น true
        const token = localStorage.getItem('authToken');
        if (token && includeAuth) {
            headers.headers = { 'Authorization': `Bearer ${token}` };
        }
        
        // เพิ่ม options อื่นๆ เช่น signal ถ้ามี
        const fetchOptions = { ...headers, ...options };
        if (options.signal) {
            fetchOptions.signal = options.signal;
        }
        
        const response = await fetch(url, fetchOptions);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        return result;
    } catch (error) {
        console.error(`API GET call failed for endpoint '${endpoint}':`, error);
        showCustomAlert(`เกิดข้อผิดพลาดในการสื่อต่อกับเซิร์ฟเวอร์: ${error.message}`);
        throw error;
    } finally {
        hideLoader();
    }
}

async function apiPost(endpoint, payload) {
    if (!API_URL) {
        showCustomAlert('กรุณาตั้งค่า API Server URL ในหน้า "ตั้งค่า"');
        return Promise.reject('URL not configured');
    }
    showLoader();
    try {
        const token = localStorage.getItem('authToken');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const options = {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
        };
        const response = await fetch(`${API_URL}/${endpoint}`, options);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error(`API POST call failed for endpoint '${endpoint}':`, error);
        showCustomAlert(`เกิดข้อผิดพลาดในการส่งข้อมูล: ${error.message}`);
        throw error;
    } finally {
        hideLoader();
    }
}

// --- Generic Helper Functions ---
function renderTable(container, data, highlightKey = null, options = {}) {
    const reportSummaryEl = document.getElementById('reportSummary');
    if (reportSummaryEl) reportSummaryEl.innerHTML = '';
    
    if (!container) return;
    if (!data || data.length === 0) {
        container.innerHTML = `<p class="text-center text-slate-500">ไม่พบข้อมูล</p>`;
        return;
    }
    const headers = Object.keys(data[0]);
    let tableHtml = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>`;
    headers.forEach(h => tableHtml += `<th scope="col" class="px-6 py-3">${h}</th>`);
    if(options.actions) tableHtml += `<th scope="col" class="px-6 py-3">Actions</th>`;
    tableHtml += `</tr></thead><tbody>`;
    data.forEach(row => {
        let highlightClass = '';
        if (highlightKey && row[highlightKey]) {
            const expiryDate = new Date(row[highlightKey]);
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const threeMonthsFromNow = new Date(); threeMonthsFromNow.setMonth(today.getMonth() + 3);
            if (expiryDate < today) highlightClass = 'bg-red-200';
            else if (expiryDate < threeMonthsFromNow) highlightClass = 'bg-yellow-100';
        }
        tableHtml += `<tr class="bg-white border-b ${highlightClass}">`;
        headers.forEach(h => {
            let value = row[h] ?? '';
            if ((h.toLowerCase().includes('date') || h.toLowerCase().includes('dob') || h.toLowerCase().includes('expiry')) && value) {
                const d = new Date(value);
                if (!isNaN(d.getTime())) value = d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
            } else if (h === 'imageUrl' && value) {
                value = `<img src="${value.replace("uc?id=", "thumbnail?id=")}" class="w-16 h-16 object-cover rounded" alt="Drug Image" loading="lazy">`;
            }
            tableHtml += `<td class="px-6 py-4 align-middle">${value}</td>`;
        });
        if(options.actions) {
            tableHtml += `<td class="px-6 py-4 align-middle space-y-2">`;
            options.actions.forEach(action => {
                tableHtml += `<div><button class="w-full text-white py-1 px-2 rounded ${action.class}" onclick="${action.handler}('${row[action.idField]}')">${action.label}</button></div>`;
            });
            tableHtml += `</td>`;
        }
        tableHtml += `</tr>`;
    });
    tableHtml += `</tbody></table>`;
    container.innerHTML = tableHtml;

    if (options.summarize && reportSummaryEl) {
        const sum = data.reduce((acc, row) => acc + (Number(row[options.summarize.column]) || 0), 0);
        reportSummaryEl.innerHTML = `<strong>${options.summarize.label}:</strong> ${sum.toFixed(2)} บาท`;
    }
}

function debounce(func, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

// --- Dashboard ---
const filterBtns = document.querySelectorAll('.filter-btn');
async function loadDashboard(period) {
    filterBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
    });

    // Update the dashboard sections with loading placeholders
    document.getElementById('dashboard-total-sales').textContent = '...';
    document.getElementById('dashboard-total-transactions').textContent = '...';
    
    // Update tables with loading messages
    document.getElementById('dashboard-top-members-table').innerHTML = '<tr><td colspan="2" class="text-center py-4 text-slate-500">กำลังโหลดข้อมูล...</td></tr>';
    document.getElementById('dashboard-low-stock-table').innerHTML = '<tr><td colspan="3" class="text-center py-4 text-slate-500">กำลังโหลดข้อมูล...</td></tr>';
    document.getElementById('dashboard-expiring-table').innerHTML = '<tr><td colspan="3" class="text-center py-4 text-slate-500">กำลังโหลดข้อมูล...</td></tr>';
    
    // Update charts with loading messages
    document.getElementById('sales-chart-container').innerHTML = '<p class="text-slate-500 text-center py-10">กำลังโหลดข้อมูล...</p>';
    document.getElementById('top-drugs-chart-container').innerHTML = '<p class="text-slate-500 text-center py-10">กำลังโหลดข้อมูล...</p>';

    try {
        // Fetch dashboard data with a timeout to prevent large requests
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        const data = await apiCall(`dashboard/${period}`, {}, false, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        // Update dashboard metrics
        document.getElementById('dashboard-total-sales').textContent = `${Number(data.totalSales || 0).toFixed(2)} บาท`;
        document.getElementById('dashboard-total-transactions').textContent = data.totalTransactions || 0;
        document.getElementById('dashboard-total-members').textContent = data.totalMembers || 0;
        
        // Update top members table
        const topMembersTable = document.getElementById('dashboard-top-members-table');
        if (data.topMembers && data.topMembers.length > 0) {
            topMembersTable.innerHTML = data.topMembers.map(member => `
                <tr class="bg-white border-b">
                    <td class="px-4 py-3">${member.fullName}</td>
                    <td class="px-4 py-3 text-right">${Number(member.totalAmount || 0).toFixed(2)}</td>
                </tr>
            `).join('');
        } else {
            topMembersTable.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-slate-500">ไม่พบข้อมูล</td></tr>';
        }
        
        // Update low stock table
        const lowStockTable = document.getElementById('dashboard-low-stock-table');
        if (data.lowStockItems && data.lowStockItems.length > 0) {
            document.getElementById('dashboard-low-stock-count').textContent = data.lowStockItems.length;
            lowStockTable.innerHTML = data.lowStockItems.map(item => `
                <tr class="bg-white border-b">
                    <td class="px-4 py-3">${item.tradeName}</td>
                    <td class="px-4 py-3 text-center">${item.totalQuantity}</td>
                    <td class="px-4 py-3 text-center">${item.minStock}</td>
                </tr>
            `).join('');
        } else {
            document.getElementById('dashboard-low-stock-count').textContent = 0;
            lowStockTable.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-slate-500">ไม่พบข้อมูล</td></tr>';
        }
        
        // Update expiring items table
        const expiringTable = document.getElementById('dashboard-expiring-table');
        if (data.expiringItems && data.expiringItems.length > 0) {
            expiringTable.innerHTML = data.expiringItems.map(item => `
                <tr class="bg-white border-b">
                    <td class="px-4 py-3">${item.tradeName}</td>
                    <td class="px-4 py-3 text-center">${item.lotNumber}</td>
                    <td class="px-4 py-3 text-center">${new Date(item.expiryDate).toLocaleDateString('th-TH')}</td>
                </tr>
            `).join('');
        } else {
            expiringTable.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-slate-500">ไม่พบข้อมูล</td></tr>';
        }
        
        // Generate charts with the fetched data
        generateSalesChart(data);
        generateTopDrugsChart(data.topDrugs || []);
        
    } catch (e) {
        console.error('Dashboard load error:', e);
        showCustomAlert('ไม่สามารถโหลดข้อมูล Dashboard ได้');
    }
}

// Dashboard chart generation functions
function generateSalesChart(data) {
    const container = document.getElementById('sales-chart-container');
    
    // Create a simple HTML-based visualization
    const maxSales = Math.max(100, (data.totalSales || 100) * 1.2);
    const currentSales = data.totalSales || 0;
    
    container.innerHTML = `
        <div class="h-full flex flex-col">
            <div class="text-center mb-2">
                <p class="text-lg font-bold text-slate-700">เปรียบเทียบกับช่วงก่อนหน้า</p>
                <p class="text-sm text-slate-500">ยอดขายล่าสุด: ${Number(currentSales).toFixed(2)} บาท</p>
            </div>
            <div class="flex-1 flex items-end space-x-1 justify-center">
                <div class="flex flex-col items-center">
                    <div class="w-8 bg-emerald-500 rounded-t text-white text-xs flex items-center justify-center" 
                         style="height: ${Math.min(100, (currentSales/maxSales)*100)}%">
                        ${Number(currentSales).toFixed(2)}
                    </div>
                    <span class="text-xs mt-1">ช่วงนี้</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-8 bg-blue-500 rounded-t text-white text-xs flex items-center justify-center" 
                         style="height: 40%">4500.00</div>
                    <span class="text-xs mt-1">ช่วงก่อน</span>
                </div>
            </div>
            <div class="mt-4 text-center">
                <p class="text-sm">
                    ${(currentSales > 4500 ? 
                    '<span class="text-emerald-600"><i class="fas fa-arrow-up mr-1"></i> เพิ่มขึ้น 12.5%</span>' : 
                    '<span class="text-red-600"><i class="fas fa-arrow-down mr-1"></i> ลดลง 8.2%</span>')} 
                    จากช่วงก่อนหน้า
                </p>
            </div>
        </div>
    `;
}

function generateTopDrugsChart(topDrugs) {
    const container = document.getElementById('top-drugs-chart-container');
    
    if (!topDrugs || topDrugs.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-center py-10">ไม่พบข้อมูล</p>';
        return;
    }
    
    // Find max quantity for scaling
    const maxQuantity = Math.max(...topDrugs.map(item => item.totalQuantity));
    
    let chartHtml = '<div class="h-full">';
    chartHtml += '<div class="mb-2"><p class="text-center text-sm text-slate-600 font-medium">10 ยาขายดี</p></div>';
    chartHtml += '<div class="space-y-2">';
    
    topDrugs.slice(0, 10).forEach((item, index) => {
        const percentage = maxQuantity > 0 ? (item.totalQuantity / maxQuantity) * 100 : 0;
        chartHtml += `
            <div class="flex items-center">
                <div class="w-1/3 text-xs pr-2 truncate">${item.genericName}</div>
                <div class="w-2/3">
                    <div class="w-full bg-slate-200 rounded-full h-4">
                        <div class="bg-gradient-to-r from-blue-500 to-emerald-500 h-4 rounded-full" 
                             style="width: ${Math.min(100, percentage)}%">
                            <div class="text-xs text-white font-medium flex items-center justify-center h-full">
                                ${item.totalQuantity}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    chartHtml += '</div></div>';
    container.innerHTML = chartHtml;
}

filterBtns.forEach(btn => btn.addEventListener('click', () => loadDashboard(btn.dataset.period)));


// Dashboard chart generation functions
function generateSalesChart(data) {
    // This is a placeholder - in a real implementation you might use Chart.js or similar
    // For now, we'll create a simple HTML-based visualization
    const container = document.getElementById('sales-chart-container');
    
    // Example data visualization - this would be replaced with actual historical data
    const maxSales = Math.max(100, (data.totalSales || 100) * 1.2);
    const currentSales = data.totalSales || 0;
    
    container.innerHTML = `
        <div class="h-full flex flex-col">
            <div class="text-center mb-2">
                <p class="text-lg font-bold text-slate-700">เปรียบเทียบกับช่วงก่อนหน้า</p>
                <p class="text-sm text-slate-500">ยอดขายล่าสุด: ${Number(currentSales).toFixed(2)} บาท</p>
            </div>
            <div class="flex-1 flex items-end space-x-1 justify-center">
                <div class="flex flex-col items-center">
                    <div class="w-8 bg-emerald-500 rounded-t text-white text-xs flex items-center justify-center" 
                         style="height: ${Math.min(100, (currentSales/maxSales)*100)}%">
                        ${Number(currentSales).toFixed(2)}
                    </div>
                    <span class="text-xs mt-1">ช่วงนี้</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-8 bg-blue-500 rounded-t text-white text-xs flex items-center justify-center" 
                         style="height: 40%">4500.00</div>
                    <span class="text-xs mt-1">ช่วงก่อน</span>
                </div>
            </div>
            <div class="mt-4 text-center">
                <p class="text-sm">
                    ${(currentSales > 4500 ? 
                    '<span class="text-emerald-600"><i class="fas fa-arrow-up mr-1"></i> เพิ่มขึ้น 12.5%</span>' : 
                    '<span class="text-red-600"><i class="fas fa-arrow-down mr-1"></i> ลดลง 8.2%</span>')} 
                    จากช่วงก่อนหน้า
                </p>
            </div>
        </div>
    `;
}

function generateTopDrugsChart(topDrugs) {
    const container = document.getElementById('top-drugs-chart-container');
    
    if (!topDrugs || topDrugs.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-center py-10">ไม่พบข้อมูล</p>';
        return;
    }
    
    // Find max quantity for scaling
    const maxQuantity = Math.max(...topDrugs.map(item => item.totalQuantity));
    
    let chartHtml = '<div class="h-full">';
    chartHtml += '<div class="mb-2"><p class="text-center text-sm text-slate-600 font-medium">10 ยาขายดี</p></div>';
    chartHtml += '<div class="space-y-2">';
    
    topDrugs.slice(0, 10).forEach((item, index) => {
        const percentage = maxQuantity > 0 ? (item.totalQuantity / maxQuantity) * 100 : 0;
        chartHtml += `
            <div class="flex items-center">
                <div class="w-1/3 text-xs pr-2 truncate">${item.genericName}</div>
                <div class="w-2/3">
                    <div class="w-full bg-slate-200 rounded-full h-4">
                        <div class="bg-gradient-to-r from-blue-500 to-emerald-500 h-4 rounded-full" 
                             style="width: ${Math.min(100, percentage)}%">
                            <div class="text-xs text-white font-medium flex items-center justify-center h-full">
                                ${item.totalQuantity}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    chartHtml += '</div></div>';
    container.innerHTML = chartHtml;
}

// --- Member Management (CRM) ---
const addMemberForm = document.getElementById('addMemberForm');
const membersTable = document.getElementById('membersTable');
const refreshMembersBtn = document.getElementById('refreshMembersBtn');

function generateAllergyFields() {
    const container = document.getElementById('allergies-container');
    container.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
        div.innerHTML = `
            <input type="text" id="allergyGenericName${i}" placeholder="ชื่อสามัญยาที่แพ้ ${i}" class="p-2 border rounded">
            <input type="text" id="allergyReaction${i}" placeholder="อาการที่พบ ${i}" class="p-2 border rounded">
        `;
        container.appendChild(div);
    }
}

async function loadMembers() {
    membersTable.innerHTML = '';
    try {
        const members = await apiCall('members');
        renderTable(membersTable, members);
    } catch (e) {
        membersTable.innerHTML = `<p class="text-red-500">ไม่สามารถโหลดข้อมูลสมาชิกได้</p>`;
    }
}

addMemberForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    btn.disabled = true;

    const allergies = [];
    for (let i = 1; i <= 5; i++) {
        const genericName = document.getElementById(`allergyGenericName${i}`).value.trim();
        const reaction = document.getElementById(`allergyReaction${i}`).value.trim();
        if (genericName) {
            allergies.push({ genericName, reaction });
        }
    }

    const payload = {
        fullName: document.getElementById('memberFullName').value,
        nationalId: document.getElementById('memberNationalID').value,
        dob: document.getElementById('memberDob').value,
        phone: document.getElementById('memberPhone').value,
        disease: document.getElementById('memberDisease').value,
        allergies: JSON.stringify(allergies)
    };
    try {
        await apiPost('members', payload);
        showCustomAlert('เพิ่มสมาชิกสำเร็จ!');
        addMemberForm.reset();
        loadMembers();
    } catch (error) { /* Handled by apiPost */ } 
    finally { btn.disabled = false; }
});
refreshMembersBtn.addEventListener('click', loadMembers);

// --- Drug Formulary & Camera ---
const addDrugFormEl = document.getElementById('addDrugForm');
const formularyTable = document.getElementById('formularyTable');
const refreshDrugsBtn = document.getElementById('refreshDrugsBtn');

async function loadFormulary() {
    formularyTable.innerHTML = '';
    try {
        const drugs = await apiCall('drugs');
        renderTable(formularyTable, drugs, null, {
            actions: [{
                label: 'ถ่ายรูป',
                class: 'bg-blue-500 hover:bg-blue-600',
                handler: 'openCameraModal',
                idField: 'drugId'
            }, {
                label: 'อัปโหลด',
                class: 'bg-indigo-500 hover:bg-indigo-600',
                handler: 'openImageUpload',
                idField: 'drugId'
            }]
        });
    } catch (e) {
        formularyTable.innerHTML = `<p class="text-red-500">ไม่สามารถโหลดข้อมูลยาได้</p>`;
    }
}

// Camera Functions
async function openCameraModal(drugId) {
    currentDrugIdForPhoto = drugId;
    cameraModal.classList.remove('hidden');
    video.classList.remove('hidden');
    photoPreview.classList.add('hidden');
    captureBtn.classList.remove('hidden');
    savePhotoBtn.classList.add('hidden');
    retakePhotoBtn.classList.add('hidden');
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
    } catch (err) {
        console.error("Error accessing camera: ", err);
        showCustomAlert('ไม่สามารถเข้าถึงกล้องได้');
        closeCameraModal();
    }
}

function closeCameraModal() {
    cameraModal.classList.add('hidden');
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
}

captureBtn.addEventListener('click', () => {
    const context = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    photoPreview.src = canvas.toDataURL('image/jpeg');
    video.classList.add('hidden');
    photoPreview.classList.remove('hidden');
    captureBtn.classList.add('hidden');
    savePhotoBtn.classList.remove('hidden');
    retakePhotoBtn.classList.remove('hidden');
});
retakePhotoBtn.addEventListener('click', () => {
    video.classList.remove('hidden');
    photoPreview.classList.add('hidden');
    captureBtn.classList.remove('hidden');
    savePhotoBtn.classList.add('hidden');
    retakePhotoBtn.classList.add('hidden');
});
closeCameraBtn.addEventListener('click', closeCameraModal);
savePhotoBtn.addEventListener('click', () => {
    const imageData = canvas.toDataURL('image/jpeg');
    const base64Data = imageData.split(',')[1];
    saveImageToServer(currentDrugIdForPhoto, base64Data);
});

// Image Upload Functions
function openImageUpload(drugId) {
    currentDrugIdForPhoto = drugId;
    imageUploadInput.click();
}
imageUploadInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64Data = e.target.result.split(',')[1];
            saveImageToServer(currentDrugIdForPhoto, base64Data);
        };
        reader.readAsDataURL(file);
    }
    event.target.value = null; // Reset input
});

async function saveImageToServer(drugId, base64ImageData) {
    showCustomAlert('ระบบใหม่ยังไม่รองรับการบันทึกรูปภาพ กรุณาใช้ Google Drive ตามระบบที่มีอยู่เดิม');
    closeCameraModal();
}

addDrugFormEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    btn.disabled = true;
    const payload = {
        drugId: document.getElementById('drugId').value,
        tradeName: document.getElementById('tradeName').value,
        genericName: document.getElementById('genericName').value,
        legalCategory: document.getElementById('legalCategory').value,
        pharmaCategory: document.getElementById('pharmaCategory').value,
        strength: document.getElementById('strength').value,
        unit: document.getElementById('unit').value,
        minStock: document.getElementById('minStock').value,
        maxStock: document.getElementById('maxStock').value,
        indication: document.getElementById('indication').value,
        caution: document.getElementById('caution').value,
        interaction1: document.getElementById('interaction1').value,
        interaction2: document.getElementById('interaction2').value,
        interaction3: document.getElementById('interaction3').value,
        interaction4: document.getElementById('interaction4').value,
        interaction5: document.getElementById('interaction5').value,
    };
    try {
        await apiPost('drugs', payload);
        showCustomAlert('บันทึกข้อมูลยาสำเร็จ!');
        addDrugFormEl.reset();
        loadFormulary();
    } catch (error) { /* Handled by apiPost */ } 
    finally { btn.disabled = false; }
});
refreshDrugsBtn.addEventListener('click', loadFormulary);

// --- Inventory Management ---
const goodsReceivedForm = document.getElementById('goodsReceivedForm');
const inventoryTable = document.getElementById('inventoryTable');
const refreshInventoryBtn = document.getElementById('refreshInventoryBtn');
const invDrugSearch = document.getElementById('invDrugSearch');
const invDrugResults = document.getElementById('invDrugResults');
const invSelectedDrugId = document.getElementById('invSelectedDrugId');
const invDrugClear = document.getElementById('invDrugClear');
const invScanBarcodeBtn = document.getElementById('invScanBarcodeBtn');
const invBarcode = document.getElementById('invBarcode');

async function loadInventorySummary() {
    inventoryTable.innerHTML = '';
    try {
        const inventory = await apiCall('inventory/summary');
        renderTable(inventoryTable, inventory, 'วันหมดอายุ');
    } catch (e) {
        inventoryTable.innerHTML = `<p class="text-red-500">ไม่สามารถโหลดข้อมูลคลังได้</p>`;
    }
}

goodsReceivedForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!invSelectedDrugId.value) {
        showCustomAlert('กรุณาค้นหาและเลือกยาก่อน');
        return;
    }
    const btn = e.target.querySelector('button');
    btn.disabled = true;
    const payload = {
        drugId: invSelectedDrugId.value,
        barcode: invBarcode.value,
        lotNumber: document.getElementById('invLotNumber').value,
        expiryDate: document.getElementById('invExpiryDate').value,
        quantity: document.getElementById('invQuantity').value,
        costPrice: document.getElementById('invCostPrice').value,
        sellingPrice: document.getElementById('invSellingPrice').value,
        referenceId: document.getElementById('invReferenceId').value
    };
    try {
        await apiPost('inventory', payload);
        showCustomAlert('บันทึกรับสินค้าเข้าสำเร็จ!');
        goodsReceivedForm.reset();
        invDrugSearch.value = '';
        invSelectedDrugId.value = '';
        invDrugClear.classList.add('hidden');
        loadInventorySummary();
    } catch (error) { /* Handled by apiPost */ }
    finally { btn.disabled = false; }
});

refreshInventoryBtn.addEventListener('click', loadInventorySummary);

invDrugSearch.addEventListener('input', debounce(async (e) => {
    const searchTerm = e.target.value.trim();
    invDrugClear.classList.toggle('hidden', searchTerm.length === 0);
    if (searchTerm.length < 2) {
        invDrugResults.classList.add('hidden');
        return;
    }
    try {
        const results = await apiCall('search/drugs', { term: searchTerm });
        invDrugResults.innerHTML = '';
        if (results.length > 0) {
            results.forEach(drug => {
                const div = document.createElement('div');
                div.textContent = `${drug.tradeName} (${drug.genericName}) - ${drug.strength}`;
                div.className = 'p-2 hover:bg-emerald-100 cursor-pointer';
                div.onclick = () => {
                    invDrugSearch.value = `${drug.tradeName} (${drug.genericName})`;
                    invSelectedDrugId.value = drug.drugId;
                    invDrugResults.classList.add('hidden');
                };
                invDrugResults.appendChild(div);
            });
            invDrugResults.classList.remove('hidden');
        } else {
            invDrugResults.classList.add('hidden');
        }
    } catch (error) { console.error('Drug search failed:', error); }
}, 300));
invDrugClear.addEventListener('click', () => {
    invDrugSearch.value = '';
    invSelectedDrugId.value = '';
    invDrugResults.classList.add('hidden');
    invDrugClear.classList.add('hidden');
    invDrugSearch.focus();
});
invScanBarcodeBtn.addEventListener('click', () => {
    openBarcodeScanner(barcode => {
        invBarcode.value = barcode;
    });
});

// --- Point of Sale (POS) ---
let posCart = [];
let selectedMemberDetails = null;
let currentDrugLots = [];
let formularyDataCache = [];
let currentSelectedPOSDrug = null;
let lastSaleData = null;

const posForm = document.getElementById('posForm');
const posMemberSearch = document.getElementById('posMemberSearch');
const posMemberClear = document.getElementById('posMemberClear');
const posMemberResults = document.getElementById('posMemberResults');
const posSelectedMember = document.getElementById('posSelectedMember');
const posDrugSearch = document.getElementById('posDrugSearch');
const posDrugClear = document.getElementById('posDrugClear');
const posDrugResults = document.getElementById('posDrugResults');
const posLotSelect = document.getElementById('posLotSelect');
const posQuantity = document.getElementById('posQuantity');
const posAddToCartBtn = document.getElementById('posAddToCartBtn');
const posCartItems = document.getElementById('posCartItems');
const posTotalAmount = document.getElementById('posTotalAmount');
const posCashReceived = document.getElementById('posCashReceived');
const posChangeGiven = document.getElementById('posChangeGiven');
const posResetCartBtn = document.getElementById('posResetCartBtn');
const posSubmitSaleBtn = document.getElementById('posSubmitSaleBtn');
const posResponseMsg = document.getElementById('posResponseMsg');
const posScanBarcodeBtn = document.getElementById('posScanBarcodeBtn');
const posDrugInfo = document.getElementById('posDrugInfo');
const posPostSaleActions = document.getElementById('posPostSaleActions');
const posPrintReceiptBtn = document.getElementById('posPrintReceiptBtn');
const posNewSaleBtn = document.getElementById('posNewSaleBtn');


function resetPOS() {
    posCart = [];
    selectedMemberDetails = null;
    currentDrugLots = [];
    currentSelectedPOSDrug = null;
    lastSaleData = null;
    posForm.reset();
    posSelectedMember.textContent = 'ลูกค้าทั่วไป';
    posMemberClear.classList.add('hidden');
    posDrugClear.classList.add('hidden');
    posDrugInfo.classList.add('hidden');
    posSubmitSaleBtn.classList.remove('hidden');
    posPostSaleActions.classList.add('hidden');
    posResponseMsg.textContent = '';
    renderPOSCart();
}

async function loadPOSData() { 
    resetPOS(); 
    try {
        formularyDataCache = await apiCall('drugs');
    } catch(e) {
        console.error("Error loading drugs data:", e);
        showCustomAlert("ไม่สามารถโหลดข้อมูลยาสำหรับตรวจสอบ Drug Interaction/Allergy ได้");
        formularyDataCache = [];
    }
}

function renderPOSCart() {
    posCartItems.innerHTML = '';
    let total = 0;
    posCart.forEach((item, index) => {
        const row = document.createElement('tr');
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        row.innerHTML = `
            <td class="p-1">${item.tradeName}</td>
            <td class="p-1 text-center">${item.lot}</td>
            <td class="p-1 text-center">${item.quantity}</td>
            <td class="p-1 text-right">${itemTotal.toFixed(2)}</td>
            <td class="p-1 text-center">
                <button type="button" class="text-red-500 hover:text-red-700" data-index="${index}"><i class="fa-solid fa-trash-can"></i></button>
            </td>`;
        posCartItems.appendChild(row);
    });
    posTotalAmount.textContent = `${total.toFixed(2)} บาท`;
    posTotalAmount.dataset.total = total;
    calculateChange();
}

function calculateChange() {
    const total = parseFloat(posTotalAmount.dataset.total) || 0;
    const cash = parseFloat(posCashReceived.value) || 0;
    const change = cash - total;
    posChangeGiven.textContent = change >= 0 ? change.toFixed(2) : '0.00';
}

async function loadMemberDetails(memberId) {
    try {
        selectedMemberDetails = await apiCall(`member/${memberId}`);
    } catch(e) {
        showCustomAlert('ไม่สามารถโหลดข้อมูลประวัติการแพ้ยาของลูกค้าได้');
        selectedMemberDetails = null;
    }
}

// เพิ่มการอ้างอิงถึงปุ่มดูประวัติ
const viewMemberHistoryBtn = document.getElementById('viewMemberHistoryBtn');

viewMemberHistoryBtn.addEventListener('click', () => {
    if (selectedMemberDetails) {
        showPurchaseHistory(selectedMemberDetails.memberId, selectedMemberDetails.fullName);
    } else {
        showCustomAlert('ไม่มีข้อมูลลูกค้า');
    }
});

posMemberSearch.addEventListener('input', debounce(async (e) => {
    const term = e.target.value.trim();
    posMemberClear.classList.toggle('hidden', term.length === 0);
    if (term.length < 2) { posMemberResults.classList.add('hidden'); return; }
    try {
        const members = await apiCall('search/members', { term });
        posMemberResults.innerHTML = '';
        if (members.length > 0) {
            members.forEach(member => {
                const div = document.createElement('div');
                div.textContent = `${member.fullName} - ${member.phone}`;
                div.className = 'p-2 hover:bg-emerald-100 cursor-pointer';
                div.onclick = () => {
                    document.getElementById('memberInfoText').textContent = `สมาชิก: ${member.fullName}`;
                    viewMemberHistoryBtn.classList.remove('hidden'); // แสดงปุ่มดูประวัติ
                    posMemberSearch.value = member.fullName;
                    posMemberResults.classList.add('hidden');
                    loadMemberDetails(member.memberId);
                };
                posMemberResults.appendChild(div);
            });
            posMemberResults.classList.remove('hidden');
        } else {
            posMemberResults.classList.add('hidden');
        }
    } catch(e) { /* handled by apiCall */ }
}, 300));

posMemberClear.addEventListener('click', () => {
    posMemberSearch.value = '';
    selectedMemberDetails = null;
    document.getElementById('memberInfoText').textContent = 'ลูกค้าทั่วไป';
    viewMemberHistoryBtn.classList.add('hidden'); // ซ่อนปุ่มดูประวัติ
    posMemberResults.classList.add('hidden');
    posMemberClear.classList.add('hidden');
    posMemberSearch.focus();
});


posDrugSearch.addEventListener('input', debounce(async (e) => {
    const term = e.target.value.trim();
    posDrugClear.classList.toggle('hidden', term.length === 0);
    posLotSelect.innerHTML = '';
    posDrugInfo.classList.add('hidden');
    if (term.length < 2) { posDrugResults.classList.add('hidden'); return; }
    try {
        const drugs = await apiCall('search/available-drugs', { term });
        posDrugResults.innerHTML = '';
        if (drugs.length > 0) {
            drugs.forEach(drug => {
                const div = document.createElement('div');
                div.className = 'p-2 hover:bg-emerald-100 cursor-pointer flex items-center gap-3';
                div.innerHTML = `
                    <img src="${drug.imageUrl ? drug.imageUrl.replace('uc?id=', 'thumbnail?id=') : 'https://placehold.co/40x40/e2e8f0/64748b?text=N/A'}" class="w-10 h-10 object-cover rounded">
                    <span>${drug.tradeName} (${drug.genericName}) - ${drug.strength}</span>
                `;
                div.onclick = () => selectPOSDrug(drug);
                posDrugResults.appendChild(div);
            });
            posDrugResults.classList.remove('hidden');
        } else {
            posDrugResults.classList.add('hidden');
        }
    } catch(e) { /* handled by apiCall */ }
}, 300));

async function selectPOSDrug(drug) {
    currentSelectedPOSDrug = drug;
    posDrugSearch.value = drug.tradeName;
    posDrugResults.classList.add('hidden');

    posDrugInfo.innerHTML = `<p class="font-semibold">ข้อบ่งใช้:</p><p class="mb-2">${drug.indication || '-'}</p><p class="font-semibold">ข้อควรระวัง:</p><p>${drug.caution || '-'}</p>`;
    posDrugInfo.classList.remove('hidden');

    try {
        currentDrugLots = await apiCall(`drug-lots/${drug.drugId}`);
        posLotSelect.innerHTML = '';
        if (currentDrugLots.length > 0) {
            currentDrugLots.forEach(lot => {
                const expiry = new Date(lot.expiryDate).toLocaleDateString('th-TH');
                const option = new Option(`Lot: ${lot.lotNumber} (หมดอายุ: ${expiry}) - คงเหลือ ${lot.quantity} ชิ้น`, lot.inventoryId);
                posLotSelect.add(option);
            });
        } else {
            posLotSelect.add(new Option('ไม่พบ Lot ที่ขายได้', ''));
        }
    } catch(e) { /* handled by apiCall */ }
}

posDrugClear.addEventListener('click', () => {
    posDrugSearch.value = '';
    posLotSelect.innerHTML = '';
    currentDrugLots = [];
    currentSelectedPOSDrug = null;
    posDrugResults.classList.add('hidden');
    posDrugClear.classList.add('hidden');
    posDrugInfo.classList.add('hidden');
    posDrugSearch.focus();
});
posScanBarcodeBtn.addEventListener('click', () => {
    openBarcodeScanner(barcode => {
        showCustomAlert('ระบบใหม่ยังไม่รองรับการค้นหาจากบาร์โค้ด');
    });
});


async function checkAllergy(newItem) {
    if (!newItem || !newItem.genericName || !selectedMemberDetails || !selectedMemberDetails.allergies) {
        return null;
    }
    const newItemGeneric = newItem.genericName.toLowerCase().trim();
    const matchedAllergy = selectedMemberDetails.allergies.find(
        allergy => allergy.genericName.toLowerCase().trim() === newItemGeneric
    );
    return matchedAllergy || null;
}

async function checkDrugInteraction(newItem) {
    if (!newItem || !newItem.genericName || formularyDataCache.length === 0) return null;
    
    const newItemGeneric = newItem.genericName.toLowerCase().trim();
    const newItemFormulary = formularyDataCache.find(d => d.drugId === newItem.drugId);
    if (!newItemFormulary) return null;

    const newItemInteractions = [
        newItemFormulary.interaction1, newItemFormulary.interaction2,
        newItemFormulary.interaction3, newItemFormulary.interaction4,
        newItemFormulary.interaction5
    ].filter(Boolean).map(i => i.toLowerCase().trim());

    for (const cartItem of posCart) {
        const cartItemGeneric = cartItem.genericName.toLowerCase().trim();
        if (newItemInteractions.includes(cartItemGeneric)) {
            return { interactingDrug: cartItem.tradeName, reason: `${newItem.tradeName} ตีกับ ${cartItem.tradeName}` };
        }
        
        const cartItemFormulary = formularyDataCache.find(d => d.drugId === cartItem.drugId);
        if (cartItemFormulary) {
             const cartItemInteractions = [
                cartItemFormulary.interaction1, cartItemFormulary.interaction2,
                cartItemFormulary.interaction3, cartItemFormulary.interaction4,
                cartItemFormulary.interaction5
            ].filter(Boolean).map(i => i.toLowerCase().trim());
            if (cartItemInteractions.includes(newItemGeneric)) {
                 return { interactingDrug: cartItem.tradeName, reason: `${cartItem.tradeName} ตีกับ ${newItem.tradeName}` };
            }
        }
    }
    return null;
}


posAddToCartBtn.addEventListener('click', async () => {
    const selectedLotId = posLotSelect.value;
    if (!selectedLotId || !currentSelectedPOSDrug) { 
        showCustomAlert('กรุณาค้นหาและเลือกรายการยาก่อน'); 
        return; 
    }

    // 1. Allergy Check
    const allergy = await checkAllergy(currentSelectedPOSDrug);
    if (allergy) {
        const confirmed = await showConfirmation(`ลูกค้ามีประวัติแพ้ยา <strong>${allergy.genericName}</strong><br>(อาการ: ${allergy.reaction || 'ไม่ระบุ'})<br><br>คุณต้องการจ่ายยานี้ต่อไปหรือไม่?`, `<i class="fa-solid fa-triangle-exclamation text-red-500 mr-2"></i> คำเตือนการแพ้ยา`);
        if (!confirmed) return;
    }
    
    // 2. Interaction Check
    const interaction = await checkDrugInteraction(currentSelectedPOSDrug);
    if (interaction) {
        const confirmed = await showConfirmation(`<strong>${interaction.reason}</strong><br><br>คุณต้องการเพิ่มยานี้ลงในตะกร้าต่อไปหรือไม่?`, `<i class="fa-solid fa-triangle-exclamation text-amber-500 mr-2"></i> คำเตือน Drug Interaction`);
        if (!confirmed) return;
    }

    // 3. Add to cart
    const lotData = currentDrugLots.find(l => l.inventoryId == selectedLotId);
    if (!lotData) { showCustomAlert('ข้อมูล Lot ไม่ถูกต้อง กรุณาเลือกยาและ Lot อีกครั้ง'); return; }
    
    const quantity = parseInt(posQuantity.value);
    if (quantity <= 0) { showCustomAlert('จำนวนต้องมากกว่า 0'); return; }
    if (quantity > lotData.quantity) { showCustomAlert('จำนวนสินค้าไม่พอในสต็อก (มีจำนวน ' + lotData.quantity + ')'); return; }
    
    posCart.push({
        inventoryId: lotData.inventoryId,
        drugId: currentSelectedPOSDrug.drugId,
        tradeName: currentSelectedPOSDrug.tradeName,
        genericName: currentSelectedPOSDrug.genericName,
        lot: lotData.lotNumber,
        price: parseFloat(lotData.sellingPrice), // แปลงเป็นตัวเลข
        quantity: quantity
    });
    renderPOSCart();
    
    posDrugSearch.value = '';
    posLotSelect.innerHTML = '';
    posQuantity.value = 1;
    currentDrugLots = [];
    currentSelectedPOSDrug = null;
    posDrugClear.classList.add('hidden');
    posDrugInfo.classList.add('hidden');
});


posCartItems.addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (button) {
        const index = button.dataset.index;
        posCart.splice(index, 1);
        renderPOSCart();
    }
});

posResetCartBtn.addEventListener('click', async () => {
    if (posCart.length === 0) return;
    const confirmed = await showConfirmation('คุณต้องการล้างตะกร้าสินค้าทั้งหมดใช่หรือไม่?');
    if (confirmed) {
        resetPOS();
    }
});
posCashReceived.addEventListener('input', calculateChange);

posForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (posCart.length === 0) { showCustomAlert('กรุณาเพิ่มสินค้าลงตะกร้าก่อน'); return; }
    if (!document.getElementById('posPharmacist').value) { showCustomAlert('กรุณากรอกชื่อเภสัชกร'); return; }
    
    posSubmitSaleBtn.disabled = true;
    posResponseMsg.textContent = '';
    
    const payload = {
        memberId: selectedMemberDetails ? selectedMemberDetails.memberId : null,
        pharmacist: document.getElementById('posPharmacist').value,
        total: parseFloat(posTotalAmount.dataset.total) || 0,
        items: posCart.map(item => ({
            inventoryId: item.inventoryId,
            drugId: item.drugId,
            quantity: item.quantity,
            price: parseFloat(item.price),
            tradeName: item.tradeName,
            genericName: item.genericName,
            lot: item.lot
        }))
    };
    
    console.log('ส่ง payload:', payload); // เพิ่ม log สำหรับ debug
    
    try {
        const result = await apiPost('sales', payload);
        console.log('การบันทึกสำเร็จ:', result);
        
        lastSaleData = {
            items: [...posCart],
            total: posTotalAmount.dataset.total,
            cashReceived: posCashReceived.value,
            changeGiven: posChangeGiven.textContent,
            pharmacist: payload.pharmacist,
            member: selectedMemberDetails ? selectedMemberDetails.fullName : 'ลูกค้าทั่วไป',
            saleDate: new Date()
        };

        posResponseMsg.textContent = 'บันทึกการขายสำเร็จ!';
        posResponseMsg.className = 'text-center text-sm font-semibold mt-2 text-emerald-600';
        posSubmitSaleBtn.classList.add('hidden');
        posPostSaleActions.classList.remove('hidden');
        
    } catch (error) {
        console.error('Error saving sale:', error);
        posResponseMsg.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
        posResponseMsg.className = 'text-center text-sm font-semibold mt-2 text-red-600';
        posSubmitSaleBtn.disabled = false;
    }
});

// ป้องกันการลงทะเบียน event listener ซ้ำ
if (!posForm._eventListenerAdded) {
    posForm._eventListenerAdded = true; // ตั้งค่าตัวแปรเพื่อป้องกันการลงทะเบียนซ้ำ
    
    posForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (posCart.length === 0) { showCustomAlert('กรุณาเพิ่มสินค้าลงตะกร้าก่อน'); return; }
        if (!document.getElementById('posPharmacist').value) { showCustomAlert('กรุณากรอกชื่อเภสัชกร'); return; }
        
        // ป้องกันการ submit ซ้ำ
        if (posForm.dataset.submitted === 'true') return;
        posForm.dataset.submitted = 'true';
        posSubmitSaleBtn.disabled = true;
        posResponseMsg.textContent = '';
        
        const payload = {
            memberId: selectedMemberDetails ? selectedMemberDetails.memberId : null,
            pharmacist: document.getElementById('posPharmacist').value,
            total: parseFloat(posTotalAmount.dataset.total) || 0,
            items: posCart.map(item => ({
                inventoryId: item.inventoryId,
                drugId: item.drugId,
                quantity: item.quantity,
                price: parseFloat(item.price),
                tradeName: item.tradeName,
                genericName: item.genericName,
                lot: item.lot
            }))
        };
        
        console.log('ส่ง payload:', payload); // เพิ่ม log สำหรับ debug
        
        try {
            const result = await apiPost('sales', payload);
            console.log('การบันทึกสำเร็จ:', result);
            
            lastSaleData = {
                items: [...posCart],
                total: posTotalAmount.dataset.total,
                cashReceived: posCashReceived.value,
                changeGiven: posChangeGiven.textContent,
                pharmacist: payload.pharmacist,
                member: selectedMemberDetails ? selectedMemberDetails.fullName : 'ลูกค้าทั่วไป',
                saleDate: new Date()
            };

            posResponseMsg.textContent = 'บันทึกการขายสำเร็จ!';
            posResponseMsg.className = 'text-center text-sm font-semibold mt-2 text-emerald-600';
            posSubmitSaleBtn.classList.add('hidden');
            posPostSaleActions.classList.remove('hidden');
            
        } catch (error) {
            console.error('Error saving sale:', error);
            posResponseMsg.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
            posResponseMsg.className = 'text-center text-sm font-semibold mt-2 text-red-600';
            posForm.dataset.submitted = 'false'; // คืนสถานะเพื่อให้สามารถลองใหม่ได้
            posSubmitSaleBtn.disabled = false;
        }
    });
} else {
    console.log("Event listener ถูกกำหนดไว้แล้ว");
}

posPrintReceiptBtn.addEventListener('click', () => {
    if (lastSaleData) {
        printReceipt(lastSaleData);
    } else {
        showCustomAlert('ยังไม่มีข้อมูลการขายสำหรับพิมพ์ใบเสร็จ');
    }
});
posNewSaleBtn.addEventListener('click', resetPOS);


function printReceipt(saleData) {
    if (!saleData) {
        showCustomAlert('ไม่มีข้อมูลการขายสำหรับพิมพ์');
        return;
    }

    let receiptContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>ใบเสร็จรับเงิน</title>
            <meta charset="UTF-8">
            <style>
                body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 20px; font-size: 12px; }
                .receipt-container { width: 300px; margin: auto; }
                h2, h3 { text-align: center; margin: 0; font-family: 'Kanit', sans-serif; }
                p { margin: 2px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { padding: 2px; }
                .text-right { text-align: right; }
                .totals { margin-top: 10px; }
                hr { border: none; border-top: 1px dashed #000; margin: 10px 0; }
            </style>
        </head>
        <body>
            <div class="receipt-container">
                <h3>ใบเสร็จรับเงิน/ใบกำกับภาษีอย่างย่อ</h3>
                <p>วันที่: ${(new Date(saleData.saleDate)).toLocaleString('th-TH')}</p>
                <p>ลูกค้า: ${saleData.member}</p>
                <p>ผู้ขาย: ${saleData.pharmacist}</p>
                <hr>
                <table>
                    <thead>
                        <tr>
                            <th>รายการ</th>
                            <th>จำนวน</th>
                            <th class="text-right">ราคา</th>
                            <th class="text-right">รวม</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    saleData.items.forEach(item => {
        receiptContent += `
            <tr>
                <td>${item.tradeName}</td>
                <td style="text-align: center;">${item.quantity}</td>
                <td class="text-right">${Number(item.price).toFixed(2)}</td>
                <td class="text-right">${(item.quantity * item.price).toFixed(2)}</td>
            </tr>
        `;
    });

    receiptContent += `
                    </tbody>
                </table>
                <hr>
                <div class="totals">
                    <p><strong>ยอดรวม:</strong> <span style="float: right;">${Number(saleData.total).toFixed(2)}</span></p>
                    <p>รับเงิน: <span style="float: right;">${Number(saleData.cashReceived).toFixed(2)}</span></p>
                    <p>เงินทอน: <span style="float: right;">${saleData.changeGiven}</span></p>
                </div>
                <hr>
                <p style="text-align: center;">ขอบคุณที่ใช้บริการ</p>
            </div>
        </body>
        </html>
    `;

    try {
        const printWindow = window.open('', '_blank', 'height=600,width=400');
        if (!printWindow) {
            showCustomAlert('ไม่สามารถเปิดหน้าต่างพิมพ์ได้ โปรดตรวจสอบการปิดกั้นหน้าต่างป๊อปอัปของเบราว์เซอร์');
            return;
        }
        
        printWindow.document.write(receiptContent);
        printWindow.document.close();
        printWindow.focus();
        
        // หน่วงเวลาเล็กน้อยก่อนพิมพ์เพื่อให้แน่ใจว่า content โหลดเสร็จ
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    } catch (error) {
        console.error('Error printing receipt:', error);
        showCustomAlert('เกิดข้อผิดพลาดในการพิมพ์ใบเสร็จ: ' + error.message);
    }
}


// --- Reports ---
const reportTypeEl = document.getElementById('reportType');
const datePickersContainer = document.getElementById('date-pickers-container');
const dailyPicker = document.getElementById('daily-picker-container');
const weeklyPicker = document.getElementById('weekly-picker-container');
const monthlyPicker = document.getElementById('monthly-picker-container');
const yearlyPicker = document.getElementById('yearly-picker-container');
const reportDateEl = document.getElementById('reportDate');
const reportWeekEl = document.getElementById('reportWeek');
const reportMonthEl = document.getElementById('reportMonth');
const reportYearEl = document.getElementById('reportYear');
const generateReportBtn = document.getElementById('generateReportBtn');
const reportResultTable = document.getElementById('reportResultTable');


function loadReports() {
    // Set default dates
    const today = new Date();
    reportDateEl.valueAsDate = today;
    reportWeekEl.valueAsDate = today;
    reportMonthEl.value = today.toISOString().substring(0, 7);
    reportYearEl.value = today.getFullYear();
    
    updateReportPickers();
    reportResultTable.innerHTML = `<p class="text-center text-slate-500">กรุณาเลือกประเภทรายงานและกด "สร้างรายงาน"</p>`;
    document.getElementById('reportSummary').innerHTML = '';
}

function updateReportPickers() {
    const selectedType = reportTypeEl.value;
    dailyPicker.classList.toggle('hidden', selectedType !== 'dailySales');
    weeklyPicker.classList.toggle('hidden', selectedType !== 'weeklySales');
    monthlyPicker.classList.toggle('hidden', selectedType !== 'monthlySales');
    yearlyPicker.classList.toggle('hidden', selectedType !== 'yearlySales');
    datePickersContainer.classList.toggle('hidden', ['inventory', 'members'].includes(selectedType));
}

reportTypeEl.addEventListener('change', updateReportPickers);

generateReportBtn.addEventListener('click', async () => {
    const type = reportTypeEl.value;
    let endpoint = '';
    let params = {};
    let options = {};

    switch(type) {
        case 'dailySales':
            const reportDate = reportDateEl.value;
            endpoint = `sales/date/${reportDate}`;
            options = { summarize: { column: 'รวม', label: 'ยอดรวม' } };
            break;
        case 'weeklySales':
            const reportWeek = reportWeekEl.value;
            endpoint = `sales/week/${reportWeek}`;
            options = { summarize: { column: 'รวม', label: 'ยอดรวม' } };
            break;
        case 'monthlySales':
            const [year, month] = reportMonthEl.value.split('-');
            endpoint = `sales/month/${year}/${month}`;
            options = { summarize: { column: 'รวม', label: 'ยอดรวม' } };
            break;
        case 'yearlySales':
            const reportYear = reportYearEl.value;
            endpoint = `sales/year/${reportYear}`;
            options = { summarize: { column: 'รวม', label: 'ยอดรวม' } };
            break;
        case 'inventory':
            endpoint = 'inventory/summary';
            break;
        case 'members':
            endpoint = 'members';
            break;
        default:
            showCustomAlert('กรุณาเลือกประเภทรายงาน');
            return;
    }

    try {
        const reportData = await apiCall(endpoint, params);
        // ตรวจสอบว่ามี totalAmount ในผลลัพธ์หรือไม่เพื่อแสดงใน summary
        if (reportData.totalAmount !== undefined) {
            const reportSummary = document.getElementById('reportSummary');
            if (reportSummary) {
                reportSummary.innerHTML = `<strong>ยอดรวม:</strong> ${Number(reportData.totalAmount).toFixed(2)} บาท`;
            }
        }
        // ลบ property ที่ไม่ต้องการแสดงในตาราง
        const displayData = reportData.filter(item => typeof item === 'object');
        renderTable(reportResultTable, displayData, null, options);
    } catch(e) {
        console.error('Report generation error:', e);
        reportResultTable.innerHTML = `<p class="text-red-500">ไม่สามารถสร้างรายงานได้: ${e.message}</p>`;
        document.getElementById('reportSummary').innerHTML = '';
    }
});

// --- Settings ---
const settingsScriptUrlEl = document.getElementById('settingsScriptUrl');
const settingsSaveBtn = document.getElementById('settingsSaveBtn');
const settingsStatusMsg = document.getElementById('settingsStatusMsg');

function loadSettings() {
    const storedUrl = localStorage.getItem('pharmacyAppApiUrl');
    if (storedUrl) {
        settingsScriptUrlEl.value = storedUrl;
        API_URL = storedUrl;
    } else {
        // กรณีไม่มีการตั้งค่าก่อนหน้านี้ ใช้ค่าเริ่มต้น
        settingsScriptUrlEl.value = window.location.origin + '/api';
        API_URL = window.location.origin + '/api';
    }
}

settingsSaveBtn.addEventListener('click', () => {
    const newUrl = settingsScriptUrlEl.value.trim();
    if (newUrl && newUrl.startsWith('http')) {
        localStorage.setItem('pharmacyAppApiUrl', newUrl);
        API_URL = newUrl;
        settingsStatusMsg.textContent = 'บันทึก URL สำเร็จ!';
        setTimeout(() => { settingsStatusMsg.textContent = ''; }, 3000);
        showCustomAlert('บันทึกการตั้งค่า URL สำเร็จแล้ว');
    } else {
        showCustomAlert('กรุณาใส่ URL ของ API Server ให้ถูกต้อง');
    }
});

// --- Barcode Scanner ---
function openBarcodeScanner(callback) {
    barcodeScannerCallback = callback;
    barcodeScannerModal.classList.remove('hidden');
    codeReader.decodeFromVideoDevice(undefined, 'barcode-video', (result, err) => {
        if (result) {
            if (barcodeScannerCallback) {
                barcodeScannerCallback(result.getText());
            }
            closeBarcodeScanner();
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error(err);
            showCustomAlert('เกิดข้อผิดพลาดในการสแกนบาร์โค้ด');
            closeBarcodeScanner();
        }
    });
}

function closeBarcodeScanner() {
    codeReader.reset();
    barcodeScannerModal.classList.add('hidden');
    barcodeScannerCallback = null;
}

closeBarcodeScannerBtn.addEventListener('click', closeBarcodeScanner);

// --- Staff Management ---
const addStaffForm = document.getElementById('addStaffForm');
const staffsTable = document.getElementById('staffsTable');
const refreshStaffsBtn = document.getElementById('refreshStaffsBtn');

async function loadStaffs() {
    staffsTable.innerHTML = '';
    try {
        const staffs = await apiCall('staffs');
        renderTable(staffsTable, staffs);
    } catch (e) {
        staffsTable.innerHTML = `<p class="text-red-500">ไม่สามารถโหลดข้อมูลเจ้าหน้าที่ได้</p>`;
    }
}

addStaffForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    btn.disabled = true;

    const payload = {
        fullName: document.getElementById('staffFullName').value,
        licenseNumber: document.getElementById('staffLicenseNumber').value,
        position: document.getElementById('staffPosition').value,
        phone: document.getElementById('staffPhone').value,
        email: document.getElementById('staffEmail').value
    };
    try {
        await apiPost('staffs', payload);
        showCustomAlert('เพิ่มเจ้าหน้าที่สำเร็จ!');
        addStaffForm.reset();
        loadStaffs();
    } catch (error) { /* Handled by apiPost */ } 
    finally { btn.disabled = false; }
});
refreshStaffsBtn.addEventListener('click', loadStaffs);

// --- Login System ---
const loginModal = document.getElementById('loginModal');
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');

// ตรวจสอบว่ามี token อยู่หรือไม่
function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
        // ถ้าไม่มี token ให้แสดง modal login
        loginModal.classList.remove('hidden');
        // ซ่อน content หลัก
        document.body.classList.add('bg-gray-100');
        document.querySelectorAll('.page, header, main').forEach(el => el.style.display = 'none');
    } else {
        // ถ้ามี token ให้ซ่อน modal login
        loginModal.classList.add('hidden');
        // แสดง content หลัก
        document.body.classList.remove('bg-gray-100');
        document.querySelectorAll('.page, header, main').forEach(el => el.style.display = '');
        // โหลดข้อมูลผู้ใช้งาน
        loadUserProfile();
    }
}

// การล็อกอิน
loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
        const response = await fetch(`${API_URL.replace('/api', '')}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            localStorage.setItem('authToken', data.token);
            localStorage.setItem('currentUser', JSON.stringify(data.user));
            loginModal.classList.add('hidden');
            document.body.classList.remove('bg-gray-100');
            document.querySelectorAll('.page, header, main').forEach(el => el.style.display = '');
            loadUserProfile();
            // โหลดหน้าเริ่มต้น
            showPage('dashboard');
        } else {
            loginError.textContent = data.error || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
            loginError.classList.remove('hidden');
        }
    } catch (error) {
        loginError.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
        loginError.classList.remove('hidden');
    }
});

// โหลดข้อมูลผู้ใช้งาน
async function loadUserProfile() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    try {
        const response = await fetch(`${API_URL.replace('/api', '')}/api/profile`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const user = await response.json();
        if (user) {
            // อัปเดต UI ตามข้อมูลผู้ใช้งาน
            updateUIForUser(user);
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
    }
}

// อัปเดต UI ตามข้อมูลผู้ใช้งาน
function updateUIForUser(user) {
    // ซ่อน/แสดงเมนูตามบทบาท
    const adminUserManagement = document.getElementById('adminUserManagement');
    if (user.role === 'admin') {
        adminUserManagement.classList.remove('hidden');
        // แสดงเมนูสำหรับ admin
        document.querySelectorAll('.admin-menu').forEach(el => {
            el.classList.remove('hidden');
        });
    } else {
        adminUserManagement.classList.add('hidden');
        // ซ่อนเมนูสำหรับ admin ถ้าไม่ใช่
        document.querySelectorAll('.admin-menu').forEach(el => {
            el.classList.add('hidden');
        });
    }
    
    // อัปเดตชื่อผู้ใช้งานใน header
    const existingUserIndicator = document.querySelector('.user-indicator');
    if (!existingUserIndicator) {
        const header = document.querySelector('header nav');
        const userIndicator = document.createElement('div');
        userIndicator.className = 'user-indicator flex items-center space-x-2 text-emerald-100';
        userIndicator.innerHTML = `
            <i class="fa-solid fa-user mr-1"></i>
            <span>${user.fullName}</span>
            <span class="text-xs bg-white/20 px-2 py-1 rounded-full capitalize">${user.role}</span>
            <button id="logoutBtn" class="ml-2 px-3 py-1 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all duration-200">ออกจากระบบ</button>
        `;
        header.appendChild(userIndicator);
        
        document.getElementById('logoutBtn').addEventListener('click', logout);
    } else {
        // อัปเดตข้อมูลผู้ใช้ถ้ามี element อยู่แล้ว
        existingUserIndicator.innerHTML = `
            <i class="fa-solid fa-user mr-1 text-emerald-100"></i>
            <span class="text-emerald-100">${user.fullName}</span>
            <span class="text-xs bg-white/20 px-2 py-1 rounded-full capitalize text-emerald-100">${user.role}</span>
            <button id="logoutBtn" class="ml-2 px-3 py-1 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all duration-200">ออกจากระบบ</button>
        `;
        document.getElementById('logoutBtn').addEventListener('click', logout);
    }
}

// ฟังก์ชันล็อกเอาท์
function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('currentUser');
    // แสดง modal login
    loginModal.classList.remove('hidden');
    document.querySelectorAll('.page, header, main').forEach(el => el.style.display = 'none');
}

// --- User Management ---
const changePasswordForm = document.getElementById('changePasswordForm');
const addUserForm = document.getElementById('addUserForm');
const refreshUsersBtn = document.getElementById('refreshUsersBtn');
const usersTable = document.getElementById('usersTable');

// ฟังก์ชันเปลี่ยนรหัสผ่าน
changePasswordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    
    if (newPassword !== confirmNewPassword) {
        showCustomAlert('รหัสผ่านใหม่ไม่ตรงกัน');
        return;
    }
    
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    try {
        const response = await fetch(`${API_URL.replace('/api', '')}/api/change-password`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ currentPassword, newPassword })
        });
        
        const data = await response.json();
        if (data.success) {
            showCustomAlert('เปลี่ยนรหัสผ่านเรียบร้อย');
            changePasswordForm.reset();
        } else {
            showCustomAlert(data.error || 'เกิดข้อผิดพลาด');
        }
    } catch (error) {
        showCustomAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
    }
});

// ฟังก์ชันเพิ่มผู้ใช้งานใหม่ (เฉพาะ admin)
addUserForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newUsername = document.getElementById('newUsername').value;
    const newFullName = document.getElementById('newFullName').value;
    const newPasswordUser = document.getElementById('newPasswordUser').value;
    const newUserRole = document.getElementById('newUserRole').value;
    
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    try {
        const response = await fetch(`${API_URL.replace('/api', '')}/api/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                username: newUsername, 
                password: newPasswordUser, 
                fullName: newFullName,
                role: newUserRole 
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showCustomAlert('เพิ่มผู้ใช้งานเรียบร้อย');
            addUserForm.reset();
            loadUsers(); // โหลดรายชื่อผู้ใช้งานใหม่
        } else {
            showCustomAlert(data.error || 'เกิดข้อผิดพลาด');
        }
    } catch (error) {
        showCustomAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
    }
});

// โหลดรายชื่อผู้ใช้งาน (เฉพาะ admin)
async function loadUsers() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    try {
        const response = await fetch(`${API_URL.replace('/api', '')}/api/users`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const users = await response.json();
        if (users) {
            // สร้างตารางแสดงรายชื่อผู้ใช้งาน
            let tableHtml = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>`;
            tableHtml += '<th class="px-6 py-3">ชื่อผู้ใช้</th><th class="px-6 py-3">ชื่อ-นามสกุล</th><th class="px-6 py-3">บทบาท</th><th class="px-6 py-3">สถานะ</th><th class="px-6 py-3">วันที่สร้าง</th><th class="px-6 py-3">เข้าสู่ระบบล่าสุด</th><th class="px-6 py-3">Actions</th>';
            tableHtml += '</tr></thead><tbody>';
            
            users.forEach(user => {
                const statusText = user.isActive === 1 ? 'เปิดใช้งาน' : 'ปิดใช้งาน';
                const statusColor = user.isActive === 1 ? 'text-green-600' : 'text-red-600';
                
                tableHtml += `<tr class="bg-white border-b"><td class="px-6 py-4">${user.username}</td>`;
                tableHtml += `<td class="px-6 py-4">${user.fullName}</td>`;
                tableHtml += `<td class="px-6 py-4">${user.role}</td>`;
                tableHtml += `<td class="px-6 py-4"><span class="${statusColor}">${statusText}</span></td>`;
                tableHtml += `<td class="px-6 py-4">${new Date(user.dateCreated).toLocaleDateString('th-TH')}</td>`;
                tableHtml += `<td class="px-6 py-4">${user.lastLogin ? new Date(user.lastLogin).toLocaleString('th-TH') : 'ยังไม่เคยเข้าระบบ'}</td>`;
                tableHtml += `<td class="px-6 py-4">
                    <button class="text-blue-600 hover:text-blue-900 mr-2" onclick="resetUserPassword('${user.id}')">Reset Password</button>
                    <button class="text-amber-600 hover:text-amber-900" onclick="toggleUserStatus('${user.id}', ${user.isActive})">${user.isActive === 1 ? 'ปิดใช้งาน' : 'เปิดใช้งาน'}</button>
                </td></tr>`;
            });
            
            tableHtml += '</tbody></table>';
            usersTable.innerHTML = tableHtml;
        }
    } catch (error) {
        usersTable.innerHTML = `<p class="text-red-500">ไม่สามารถโหลดข้อมูลผู้ใช้งานได้</p>`;
    }
}

// รีเซ็ตรหัสผ่านผู้ใช้ (เฉพาะ admin)
async function resetUserPassword(userId) {
    const newPassword = prompt('กรอกรหัสผ่านใหม่:');
    if (!newPassword) return;
    
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    try {
        const response = await fetch(`${API_URL.replace('/api', '')}/api/reset-password/${userId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ newPassword })
        });
        
        const data = await response.json();
        if (data.success) {
            showCustomAlert('รีเซ็ตรหัสผ่านเรียบร้อย');
            loadUsers(); // โหลดรายชื่อใหม่
        } else {
            showCustomAlert(data.error || 'เกิดข้อผิดพลาด');
        }
    } catch (error) {
        showCustomAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
    }
}

// เปลี่ยนสถานะผู้ใช้งาน (เฉพาะ admin)
async function toggleUserStatus(userId, currentStatus) {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    try {
        const response = await fetch(`${API_URL.replace('/api', '')}/api/toggle-user/${userId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        if (data.success) {
            showCustomAlert(data.message);
            loadUsers(); // โหลดรายชื่อใหม่
        } else {
            showCustomAlert(data.error || 'เกิดข้อผิดพลาด');
        }
    } catch (error) {
        showCustomAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
    }
}

refreshUsersBtn.addEventListener('click', loadUsers);

// --- Admin Dashboard ---
async function loadAdminDashboard() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    try {
        // Load user statistics
        const usersResponse = await fetch(`${API_URL.replace('/api', '')}/api/users`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await usersResponse.json();
        document.getElementById('admin-total-users').textContent = users ? users.length : 0;
        
        // Load sales statistics
        const token = localStorage.getItem('authToken');
        const salesResponse = await fetch(`${API_URL.replace('/api', '')}/api/sales/summary`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const salesData = await salesResponse.json();
        if (salesData && salesData.summary) {
            document.getElementById('admin-total-sales').textContent = `${Number(salesData.summary.totalRevenue || 0).toFixed(2)} บาท`;
        }
        
        // Load members statistics
        const members = await apiCall('members');
        document.getElementById('admin-total-members').textContent = members ? members.length : 0;
        
        // Load drugs statistics
        const drugs = await apiCall('drugs');
        document.getElementById('admin-total-drugs').textContent = drugs ? drugs.length : 0;
        
        // Load recent activities
        loadRecentActivities();
        
    } catch (error) {
        console.error('Error loading admin dashboard:', error);
    }
}

async function loadRecentActivities() {
    // For demo purposes, showing placeholder activities
    // In a real system, this would connect to an activity log
    const activityList = document.getElementById('admin-activity-list');
    activityList.innerHTML = '';
    
    // Add some placeholder activities
    const activities = [
        { time: new Date(Date.now() - 3600000).toLocaleString('th-TH'), activity: 'การขายยา', user: 'เภสัชกรสมศรี', details: 'ขายยาพาราเซตามอล 2 ชิ้น' },
        { time: new Date(Date.now() - 7200000).toLocaleString('th-TH'), activity: 'เพิ่มยาใหม่', user: 'ผู้ดูแลระบบ', details: 'เพิ่มยา Amoxicillin ลงในระบบ' },
        { time: new Date(Date.now() - 10800000).toLocaleString('th-TH'), activity: 'เพิ่มลูกค้าใหม่', user: 'เภสัชกรสมชาย', details: 'เพิ่มลูกค้าใหม่ชื่อ นางสาวสมหญิง' },
        { time: new Date(Date.now() - 14400000).toLocaleString('th-TH'), activity: 'รับสินค้าเข้า', user: 'เจ้าหน้าที่คลัง', details: 'รับยาพาราเซตามอล Lot: P2024A จำนวน 100 ชิ้น' }
    ];
    
    activities.forEach(activity => {
        const row = document.createElement('tr');
        row.className = 'bg-white border-b';
        row.innerHTML = `
            <td class="px-6 py-4">${activity.time}</td>
            <td class="px-6 py-4">${activity.activity}</td>
            <td class="px-6 py-4">${activity.user}</td>
            <td class="px-6 py-4">${activity.details}</td>
        `;
        activityList.appendChild(row);
    });
}

// Export buttons for admin dashboard
document.getElementById('export-sales-btn').addEventListener('click', () => {
    downloadFile('/api/export/sales', 'sales_report');
});

document.getElementById('export-inventory-btn').addEventListener('click', () => {
    downloadFile('/api/export/inventory', 'inventory_report');
});

document.getElementById('export-members-btn').addEventListener('click', () => {
    downloadFile('/api/export/members', 'members_report');
});

document.getElementById('export-staffs-btn').addEventListener('click', () => {
    downloadFile('/api/export/staffs', 'staffs_report');
});

// Function to download CSV files
function downloadFile(endpoint, filename) {
    const token = localStorage.getItem('authToken');
    if (!token) {
        showCustomAlert('กรุณาเข้าสู่ระบบก่อน');
        return;
    }
    
    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = `${API_URL.replace('/api', '')}${endpoint}`;
    link.download = `${filename}_${new Date().toISOString().slice(0, 10)}.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // Add authorization header by using fetch first, then creating the download link
    // Note: This is a simplified implementation - in production, you'd need proper authentication for file downloads
    fetch(`${API_URL.replace('/api', '')}${endpoint}`, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        link.href = url;
        link.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(link);
    })
    .catch(error => {
        console.error('Download error:', error);
        showCustomAlert('เกิดข้อผิดพลาดในการดาวน์โหลดไฟล์');
    });
}

// --- Purchase History Modal ---
const purchaseHistoryModal = document.getElementById('purchaseHistoryModal');
const purchaseHistoryContent = document.getElementById('purchaseHistoryContent');
const closePurchaseHistoryBtn = document.getElementById('closePurchaseHistoryBtn');

function showPurchaseHistory(memberId, memberName) {
    purchaseHistoryModal.classList.remove('hidden');
    purchaseHistoryContent.innerHTML = '<p class="text-center">กำลังโหลด...</p>';
    
    apiCall(`member/${memberId}/purchases`)
        .then(purchases => {
            if (purchases && purchases.length > 0) {
                let html = `<h4 class="font-bold mb-2">ประวัติการซื้อของ ${memberName}</h4>`;
                html += '<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>';
                html += '<th class="px-6 py-3">วันที่</th><th class="px-6 py-3">รายการ</th><th class="px-6 py-3">จำนวน</th><th class="px-6 py-3">ราคา/หน่วย</th><th class="px-6 py-3">รวม</th><th class="px-6 py-3">เภสัชกร</th></tr></thead><tbody>';
                
                purchases.forEach(purchase => {
                    const saleDate = new Date(purchase.saleDate).toLocaleString('th-TH');
                    html += `<tr class="bg-white border-b"><td class="px-6 py-4">${saleDate}</td>`;
                    html += `<td class="px-6 py-4">${purchase.tradeName} (${purchase.genericName})</td>`;
                    html += `<td class="px-6 py-4 text-center">${purchase.quantitySold}</td>`;
                    html += `<td class="px-6 py-4 text-right">${Number(purchase.pricePerUnit).toFixed(2)}</td>`;
                    html += `<td class="px-6 py-4 text-right">${Number(purchase.totalItemPrice).toFixed(2)}</td>`;
                    html += `<td class="px-6 py-4">${purchase.pharmacist}</td></tr>`;
                });
                
                html += '</tbody></table>';
                purchaseHistoryContent.innerHTML = html;
            } else {
                purchaseHistoryContent.innerHTML = `<p class="text-center">ยังไม่มีประวัติการซื้อ</p>`;
            }
        })
        .catch(error => {
            purchaseHistoryContent.innerHTML = `<p class="text-center text-red-500">ไม่สามารถโหลดข้อมูลประวัติการซื้อได้: ${error.message}</p>`;
        });
}

closePurchaseHistoryBtn.addEventListener('click', () => {
    purchaseHistoryModal.classList.add('hidden');
});

// ตรวจสอบสิทธิ์เมื่อโหลดหน้า
document.addEventListener('DOMContentLoaded', checkAuth);
</script>

<!-- Footer -->
<footer class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-6 mt-8">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center space-x-3 mb-4 md:mb-0">
                <img src="https://i.postimg.cc/yY1rPJ07/wirun-facbook.png" alt="Logo" class="w-12 h-12 object-contain">
                <div>
                    <h3 class="font-bold font-kanit">PMS</h3>
                    <p class="text-xs text-emerald-100">Pharmacy Management System</p>
                </div>
            </div>
            <div class="text-center md:text-right">
                <p class="text-sm">ออกแบบโดย</p>
                <p class="font-bold">เภสัชกรวิรุณ เวชศิริ</p>
                <p class="text-xs text-emerald-200">www.pharmconnection.net</p>
            </div>
        </div>
        <div class="border-t border-emerald-500/50 mt-4 pt-4 text-center text-xs text-emerald-200">
            <p>&copy; 2025 Pharmacy Management System. สงวนลิขสิทธิ์ทุกประการ</p>
            <p class="mt-1">English Name: Wirun Wetsiri</p>
        </div>
    </div>
</footer>
</body>
</html>
