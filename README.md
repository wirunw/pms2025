# ระบบจัดการร้านยา (SQLite Version)

ระบบจัดการร้านยาที่ใช้ Node.js และ SQLite แทน Google Apps Script และ Google Sheets

## คุณสมบัติใหม่

- ใช้ฐานข้อมูล SQLite ที่มีประสิทธิภาพมากกว่า Google Sheets
- ใช้ API ที่สร้างด้วย Node.js แทน Google Apps Script
- รองรับการ query ที่ซับซ้อนมากขึ้น
- รองรับการ relationship ระหว่างข้อมูล
- ทำงานได้เร็วขึ้นและเชื่อถือได้มากขึ้น

### การปรับปรุงล่าสุด

- ปรับปรุงการส่งออก CSV ให้เป็น UTF-8 พร้อม BOM เพื่อให้โปรแกรมสเปรดชีตอ่านภาษาไทยได้ถูกต้อง
- เพิ่มปุ่มลบข้อมูลยาแบบหลายรายการพร้อมตรวจสอบความเชื่อมโยงกับข้อมูลขาย เพื่อป้องกันการลบที่มีผลกระทบ
- เพิ่มเมนูดาวน์โหลดไฟล์ฐานข้อมูล (.db) สำหรับการสำรองข้อมูลผ่านหน้า Settings
- เพิ่มระบบบันทึกกิจกรรม (Activity Log) และแสดงผลในหน้าแดชบอร์ดผู้ดูแล
- ปรับหน้าเว็บให้ดึงข้อมูลก็ต่อเมื่อมีการเข้าสู่ระบบ ช่วยลดข้อผิดพลาด 401 ก่อนเข้าสู่ระบบ
- จำกัดสิทธิ์ลบรายการยาเฉพาะผู้ดูแลระบบ และซ่อนปุ่มลบสำหรับผู้ใช้ทั่วไป
- เพิ่มฟอร์มแก้ไข/ลบสมาชิกและเจ้าหน้าที่แบบเลือกหลายรายการ พร้อมบล็อกการลบสมาชิกที่มีประวัติการซื้อ
- ขยายหมวดหมู่สินค้า (pharma category) ให้ครอบคลุมประเภทสินค้าร้านยามากขึ้น เช่น ยาโรคเรื้อรัง ผลิตภัณฑ์แม่และเด็ก และอุปกรณ์ผู้ป่วยติดเตียง
- ใช้ไฟล์ `index.html` เป็นหน้า UI หลักเพียงชุดเดียว โดยเส้นทาง `/` และ `index_sqlite.html` จะเปลี่ยนเส้นทางมายังไฟล์นี้เพื่อให้ทั้ง Railway และ localhost แสดงผลเหมือนกัน

## โครงสร้างโปรเจกต์

- `server.js` - เซิร์ฟเวอร์ API หลัก
- `db.js` - ไฟล์จัดการฐานข้อมูล SQLite
- `migrate.js` - ไฟล์สำหรับย้ายข้อมูลจาก Google Sheets
- `index.html` - หน้าเว็บหลักที่เชื่อมต่อกับ API (เส้นทาง `/` จะใช้ไฟล์นี้)
- `index_sqlite.html` - หน้า redirect มายัง `index.html` สำหรับความเข้ากันได้กับลิงก์เดิม

## การติดตั้ง

1. ติดตั้ง Node.js ถ้ายังไม่ได้ติดตั้ง
2. รันคำสั่งนี้ในโฟลเดอร์โปรเจกต์:
```bash
npm install
```

## การรันแอปพลิเคชัน

1. รันเซิร์ฟเวอร์:
```bash
npm start
```
หรือ
```bash
node server.js
```

2. เปิดเบราว์เซอร์แล้วไปที่ `http://localhost:3000`

3. ตั้งค่า URL ในหน้า Settings ของแอปเป็น `http://localhost:3000/api`

## การย้ายข้อมูลจาก Google Sheets

หากคุณต้องการย้ายข้อมูลจาก Google Sheets เดิม:

1. สร้างไฟล์ JSON จากข้อมูล Google Sheets
2. แก้ไขไฟล์ `migrate.js` เพื่อใช้ข้อมูลจริงของคุณ
3. รันคำสั่ง:
```bash
node migrate.js
```

## ข้อดีของระบบใหม่

1. **ความเร็ว** - การ query ข้อมูลเร็วกว่า Google Sheets มาก
2. **ความน่าเชื่อถือ** - ไม่ขึ้นกับบริการภายนอก
3. **ความสามารถในการปรับขนาด** - รองรับข้อมูลจำนวนมากได้ดี
4. **ความปลอดภัย** - ควบคุมการเข้าถึงข้อมูลได้มากขึ้น
5. **ฟีเจอร์ขั้นสูง** - รองรับ transaction, stored procedure ฯลฯ

## วิธีอัปเดตโค้ดบน VS Code ให้เป็นเวอร์ชันล่าสุด

หากคุณมีโค้ดเก่าอยู่ใน VS Code และต้องการอัปเดตให้ตรงกับโค้ดเวอร์ชันใหม่จากรีโปนี้ สามารถทำตามขั้นตอนต่อไปนี้:

1. **สำรองงานที่ยังไม่เสร็จ** – หากคุณแก้ไขไฟล์ไว้แต่ยังไม่ commit ให้สำรองหรือ commit ไว้ก่อน เพื่อป้องกันการสูญหายของงาน
2. เปิด VS Code แล้วเปิดโฟลเดอร์โปรเจกต์นี้ จากนั้นเปิด Terminal ภายใน VS Code (ปกติใช้คีย์ลัด <kbd>Ctrl</kbd>+<kbd>`</kbd>)
3. ตรวจสอบว่าตำแหน่งปัจจุบันอยู่ในโฟลเดอร์โปรเจกต์ แล้วรันคำสั่ง:
   ```bash
   git fetch origin
   git status
   ```
   คำสั่งแรกจะดึงข้อมูลล่าสุดจากรีโมต ส่วน `git status` ใช้ตรวจสอบว่าโฟลเดอร์ทำงานอยู่บน branch ไหนและมีไฟล์แก้ไขค้างอยู่หรือไม่
4. หากไม่มีงานค้างอยู่ (หรือคุณได้ commit/สำรองไว้แล้ว) ให้ดึงโค้ดล่าสุดมาด้วยคำสั่ง:
   ```bash
   git pull origin main
   ```
   ถ้าคุณใช้ branch อื่นอยู่ ให้เปลี่ยน `main` เป็นชื่อ branch นั้น
5. หลังจาก pull เสร็จ ให้รันคำสั่ง `npm install` อีกครั้งเพื่อให้แน่ใจว่าขึ้นกับแพ็กเกจเวอร์ชันล่าสุดครบถ้วน แล้วค่อยรัน `npm start` หรือคำสั่งที่คุณใช้ deploy

> หากมีการแก้ไขค้างอยู่และไม่ต้องการให้ merge ทับ สามารถสร้าง branch ใหม่แล้ว commit เก็บไว้ก่อน หรือใช้ `git stash` เพื่อซ่อนงานชั่วคราว จากนั้นค่อย `git pull` แล้วใช้ `git stash pop` เพื่อนำงานเดิมกลับมาปรับให้เข้ากับโค้ดล่าสุด
